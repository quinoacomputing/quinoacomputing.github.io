
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Cppcheck - HTML report - [<a href=https://github.com/quinoacomputing/quinoa/commit/-128-NOTFOUND>-128-NOTFOUND</a>]</title>
    <link rel="stylesheet" href="style.css">
    <style>
pre { line-height: 125%; margin: 0; }
td.linenos pre { color: #000000; background-color: #f0f0f0; padding: 0 5px 0 5px; }
span.linenos { color: #000000; background-color: #f0f0f0; padding: 0 5px 0 5px; }
td.linenos pre.special { color: #000000; background-color: #ffffc0; padding: 0 5px 0 5px; }
span.linenos.special { color: #000000; background-color: #ffffc0; padding: 0 5px 0 5px; }
.highlight .hll { background-color: #ffffcc }
.highlight { background: #ffffff; }
.highlight .c { color: #888888 } /* Comment */
.highlight .err { color: #FF0000; background-color: #FFAAAA } /* Error */
.highlight .k { color: #008800; font-weight: bold } /* Keyword */
.highlight .o { color: #333333 } /* Operator */
.highlight .ch { color: #888888 } /* Comment.Hashbang */
.highlight .cm { color: #888888 } /* Comment.Multiline */
.highlight .cp { color: #557799 } /* Comment.Preproc */
.highlight .cpf { color: #888888 } /* Comment.PreprocFile */
.highlight .c1 { color: #888888 } /* Comment.Single */
.highlight .cs { color: #cc0000; font-weight: bold } /* Comment.Special */
.highlight .gd { color: #A00000 } /* Generic.Deleted */
.highlight .ge { font-style: italic } /* Generic.Emph */
.highlight .gr { color: #FF0000 } /* Generic.Error */
.highlight .gh { color: #000080; font-weight: bold } /* Generic.Heading */
.highlight .gi { color: #00A000 } /* Generic.Inserted */
.highlight .go { color: #888888 } /* Generic.Output */
.highlight .gp { color: #c65d09; font-weight: bold } /* Generic.Prompt */
.highlight .gs { font-weight: bold } /* Generic.Strong */
.highlight .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
.highlight .gt { color: #0044DD } /* Generic.Traceback */
.highlight .kc { color: #008800; font-weight: bold } /* Keyword.Constant */
.highlight .kd { color: #008800; font-weight: bold } /* Keyword.Declaration */
.highlight .kn { color: #008800; font-weight: bold } /* Keyword.Namespace */
.highlight .kp { color: #003388; font-weight: bold } /* Keyword.Pseudo */
.highlight .kr { color: #008800; font-weight: bold } /* Keyword.Reserved */
.highlight .kt { color: #333399; font-weight: bold } /* Keyword.Type */
.highlight .m { color: #6600EE; font-weight: bold } /* Literal.Number */
.highlight .s { background-color: #fff0f0 } /* Literal.String */
.highlight .na { color: #0000CC } /* Name.Attribute */
.highlight .nb { color: #007020 } /* Name.Builtin */
.highlight .nc { color: #BB0066; font-weight: bold } /* Name.Class */
.highlight .no { color: #003366; font-weight: bold } /* Name.Constant */
.highlight .nd { color: #555555; font-weight: bold } /* Name.Decorator */
.highlight .ni { color: #880000; font-weight: bold } /* Name.Entity */
.highlight .ne { color: #FF0000; font-weight: bold } /* Name.Exception */
.highlight .nf { color: #0066BB; font-weight: bold } /* Name.Function */
.highlight .nl { color: #997700; font-weight: bold } /* Name.Label */
.highlight .nn { color: #0e84b5; font-weight: bold } /* Name.Namespace */
.highlight .nt { color: #007700 } /* Name.Tag */
.highlight .nv { color: #996633 } /* Name.Variable */
.highlight .ow { color: #000000; font-weight: bold } /* Operator.Word */
.highlight .w { color: #bbbbbb } /* Text.Whitespace */
.highlight .mb { color: #6600EE; font-weight: bold } /* Literal.Number.Bin */
.highlight .mf { color: #6600EE; font-weight: bold } /* Literal.Number.Float */
.highlight .mh { color: #005588; font-weight: bold } /* Literal.Number.Hex */
.highlight .mi { color: #0000DD; font-weight: bold } /* Literal.Number.Integer */
.highlight .mo { color: #4400EE; font-weight: bold } /* Literal.Number.Oct */
.highlight .sa { background-color: #fff0f0 } /* Literal.String.Affix */
.highlight .sb { background-color: #fff0f0 } /* Literal.String.Backtick */
.highlight .sc { color: #0044DD } /* Literal.String.Char */
.highlight .dl { background-color: #fff0f0 } /* Literal.String.Delimiter */
.highlight .sd { color: #DD4422 } /* Literal.String.Doc */
.highlight .s2 { background-color: #fff0f0 } /* Literal.String.Double */
.highlight .se { color: #666666; font-weight: bold; background-color: #fff0f0 } /* Literal.String.Escape */
.highlight .sh { background-color: #fff0f0 } /* Literal.String.Heredoc */
.highlight .si { background-color: #eeeeee } /* Literal.String.Interpol */
.highlight .sx { color: #DD2200; background-color: #fff0f0 } /* Literal.String.Other */
.highlight .sr { color: #000000; background-color: #fff0ff } /* Literal.String.Regex */
.highlight .s1 { background-color: #fff0f0 } /* Literal.String.Single */
.highlight .ss { color: #AA6600 } /* Literal.String.Symbol */
.highlight .bp { color: #007020 } /* Name.Builtin.Pseudo */
.highlight .fm { color: #0066BB; font-weight: bold } /* Name.Function.Magic */
.highlight .vc { color: #336699 } /* Name.Variable.Class */
.highlight .vg { color: #dd7700; font-weight: bold } /* Name.Variable.Global */
.highlight .vi { color: #3333BB } /* Name.Variable.Instance */
.highlight .vm { color: #996633 } /* Name.Variable.Magic */
.highlight .il { color: #0000DD; font-weight: bold } /* Literal.Number.Integer.Long */
    </style>
    <script>
      function getStyle(el, styleProp) {
        var y;

        if (el.currentStyle) {
          y = el.currentStyle[styleProp];
        } else if (window.getComputedStyle) {
          y = document.defaultView.getComputedStyle(el, null).getPropertyValue(styleProp);
        }

        return y;
      }

      function toggle() {
        var el = this.expandable_content;
        var mark = this.expandable_marker;

        if (el.style.display === "block") {
          el.style.display = "none";
          mark.textContent = "[+]";
        } else {
          el.style.display = "block";
          mark.textContent = "[-]";
        }
      }

      function initExpandables() {
        var elements = document.querySelectorAll(".expandable");

        for (var i = 0, len = elements.length; i < len; i++) {
          var el = elements[i];
          var clickable = el.querySelector("span");
          var marker = clickable.querySelector(".marker");
          var content = el.querySelector(".content");
          var width = clickable.clientWidth - parseInt(getStyle(content, "padding-left")) - parseInt(getStyle(content, "padding-right"));
          content.style.width = width + "px";
          clickable.expandable_content = content;
          clickable.expandable_marker = marker;
          clickable.addEventListener("click", toggle);
        }
      }

      function toggleDisplay(id) {
        var elements = document.querySelectorAll("." + id);

        for (var i = 0, len = elements.length; i < len; i++) {
          elements[i].classList.toggle("d-none");
        }
      }

      function toggleAll() {
        var elements = document.querySelectorAll("input");

        // starting from 1 since 0 is the "toggle all" input
        for (var i = 1, len = elements.length; i < len; i++) {
          var el = elements[i];

          if (el.checked) {
            el.checked = false;
          } else {
            el.checked = true;
          }

          toggleDisplay(el.id);
        }
      }
      window.addEventListener("load", initExpandables);
    </script>
  </head>
  <body>
    <div id="header" class="header">
      <h1>Cppcheck report - [<a href=https://github.com/quinoacomputing/quinoa/commit/-128-NOTFOUND>-128-NOTFOUND</a>]: /tmp/TeamCity-2/work/5ad443c8abe7fc0a/src/Inciter/Partitioner.cpp</h1>
    </div>
    <div class="wrapper">
      <div id="menu">
       <p id="filename"><a href="index.html">Defects:</a> Partitioner.cpp</p>
<a href="76.html#line-425"> variableScope 425</a>
    </div>
    <div id="content">
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352
353
354
355
356
357
358
359
360
361
362
363
364
365
366
367
368
369
370
371
372
373
374
375
376
377
378
379
380
381
382
383
384
385
386
387
388
389
390
391
392
393
394
395
396
397
398
399
400
401
402
403
404
405
406
407
408
409
410
411
412
413
414
415
416
417
418
419
420
421
422
423
424
425
426
427
428
429
430
431
432
433
434
435
436
437
438
439
440
441
442
443
444
445
446
447
448
449
450
451
452
453
454
455
456
457
458
459
460
461
462
463
464
465
466
467
468
469
470
471
472
473
474
475
476
477
478
479
480
481
482
483
484
485
486
487
488
489
490
491
492
493
494
495
496
497
498
499
500
501
502
503
504
505
506
507
508
509
510
511
512
513
514
515
516
517
518
519
520
521
522
523
524
525
526
527
528
529
530
531
532
533
534
535
536
537
538
539
540
541
542
543
544
545
546
547
548
549
550
551
552
553
554
555
556
557
558
559
560
561
562
563
564
565
566
567
568
569
570
571
572
573
574
575
576
577
578
579
580
581
582
583
584
585
586
587
588
589
590
591
592
593
594
595
596
597
598
599
600
601
602
603
604
605
606
607
608
609
610
611
612
613
614
615
616
617
618
619
620
621
622
623
624
625
626
627
628
629
630
631
632
633</pre></div></td><td class="code"><div class="highlight"><pre><span></span><a name="line-1"></a><span class="c1">// *****************************************************************************</span>
<a name="line-2"></a><span class="cm">/*!</span>
<a name="line-3"></a><span class="cm">  \file      src/Inciter/Partitioner.cpp</span>
<a name="line-4"></a><span class="cm">  \copyright 2012-2015 J. Bakosi,</span>
<a name="line-5"></a><span class="cm">             2016-2018 Los Alamos National Security, LLC.,</span>
<a name="line-6"></a><span class="cm">             2019-2021 Triad National Security, LLC.</span>
<a name="line-7"></a><span class="cm">             All rights reserved. See the LICENSE file for details.</span>
<a name="line-8"></a><span class="cm">  \brief     Charm++ chare partitioner nodegroup used to perform mesh</span>
<a name="line-9"></a><span class="cm">             partitioning</span>
<a name="line-10"></a><span class="cm">  \details   Charm++ chare partitioner nodegroup used to perform mesh read and</span>
<a name="line-11"></a><span class="cm">             partitioning, one worker per compute node.</span>
<a name="line-12"></a><span class="cm">*/</span>
<a name="line-13"></a><span class="c1">// *****************************************************************************</span>
<a name="line-14"></a>
<a name="line-15"></a><span class="cp">#include</span> <span class="cpf">&lt;numeric&gt;</span><span class="cp"></span>
<a name="line-16"></a>
<a name="line-17"></a><span class="cp">#include</span> <span class="cpf">&quot;NoWarning/kokkos_cr.hpp&quot;</span><span class="cp"></span>
<a name="line-18"></a>
<a name="line-19"></a><span class="cp">#include</span> <span class="cpf">&quot;Partitioner.hpp&quot;</span><span class="cp"></span>
<a name="line-20"></a><span class="cp">#include</span> <span class="cpf">&quot;DerivedData.hpp&quot;</span><span class="cp"></span>
<a name="line-21"></a><span class="cp">#include</span> <span class="cpf">&quot;Reorder.hpp&quot;</span><span class="cp"></span>
<a name="line-22"></a><span class="cp">#include</span> <span class="cpf">&quot;MeshReader.hpp&quot;</span><span class="cp"></span>
<a name="line-23"></a><span class="cp">#include</span> <span class="cpf">&quot;CGPDE.hpp&quot;</span><span class="cp"></span>
<a name="line-24"></a><span class="cp">#include</span> <span class="cpf">&quot;DGPDE.hpp&quot;</span><span class="cp"></span>
<a name="line-25"></a><span class="cp">#include</span> <span class="cpf">&quot;Inciter/Options/Scheme.hpp&quot;</span><span class="cp"></span>
<a name="line-26"></a><span class="cp">#include</span> <span class="cpf">&quot;UnsMesh.hpp&quot;</span><span class="cp"></span>
<a name="line-27"></a><span class="cp">#include</span> <span class="cpf">&quot;ContainerUtil.hpp&quot;</span><span class="cp"></span>
<a name="line-28"></a><span class="cp">#include</span> <span class="cpf">&quot;Callback.hpp&quot;</span><span class="cp"></span>
<a name="line-29"></a>
<a name="line-30"></a><span class="k">namespace</span> <span class="n">inciter</span> <span class="p">{</span>
<a name="line-31"></a>
<a name="line-32"></a><span class="k">extern</span> <span class="n">ctr</span><span class="o">::</span><span class="n">InputDeck</span> <span class="n">g_inputdeck</span><span class="p">;</span>
<a name="line-33"></a>
<a name="line-34"></a><span class="p">}</span> <span class="c1">// inciter::</span>
<a name="line-35"></a>
<a name="line-36"></a><span class="k">using</span> <span class="n">inciter</span><span class="o">::</span><span class="n">Partitioner</span><span class="p">;</span>
<a name="line-37"></a>
<a name="line-38"></a><span class="n">Partitioner</span><span class="o">::</span><span class="n">Partitioner</span><span class="p">(</span>
<a name="line-39"></a>  <span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="n">meshid</span><span class="p">,</span>
<a name="line-40"></a>  <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">filename</span><span class="p">,</span>
<a name="line-41"></a>  <span class="k">const</span> <span class="n">tk</span><span class="o">::</span><span class="n">PartitionerCallback</span><span class="o">&amp;</span> <span class="n">cbp</span><span class="p">,</span>
<a name="line-42"></a>  <span class="k">const</span> <span class="n">tk</span><span class="o">::</span><span class="n">RefinerCallback</span><span class="o">&amp;</span> <span class="n">cbr</span><span class="p">,</span>
<a name="line-43"></a>  <span class="k">const</span> <span class="n">tk</span><span class="o">::</span><span class="n">SorterCallback</span><span class="o">&amp;</span> <span class="n">cbs</span><span class="p">,</span>
<a name="line-44"></a>  <span class="k">const</span> <span class="n">CProxy_Transporter</span><span class="o">&amp;</span> <span class="n">host</span><span class="p">,</span>
<a name="line-45"></a>  <span class="k">const</span> <span class="n">CProxy_Refiner</span><span class="o">&amp;</span> <span class="n">refiner</span><span class="p">,</span>
<a name="line-46"></a>  <span class="k">const</span> <span class="n">CProxy_Sorter</span><span class="o">&amp;</span> <span class="n">sorter</span><span class="p">,</span>
<a name="line-47"></a>  <span class="k">const</span> <span class="n">tk</span><span class="o">::</span><span class="n">CProxy_MeshWriter</span><span class="o">&amp;</span> <span class="n">meshwriter</span><span class="p">,</span>
<a name="line-48"></a>  <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span> <span class="n">Scheme</span> <span class="o">&gt;&amp;</span> <span class="n">scheme</span><span class="p">,</span>
<a name="line-49"></a>  <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span> <span class="kt">int</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span> <span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="o">&gt;</span> <span class="o">&gt;&amp;</span> <span class="n">bface</span><span class="p">,</span>
<a name="line-50"></a>  <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span> <span class="kt">int</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span> <span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="o">&gt;</span> <span class="o">&gt;&amp;</span> <span class="n">faces</span><span class="p">,</span>
<a name="line-51"></a>  <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span> <span class="kt">int</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span> <span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="o">&gt;</span> <span class="o">&gt;&amp;</span> <span class="n">bnode</span> <span class="p">)</span> <span class="o">:</span>
<a name="line-52"></a>  <span class="n">m_meshid</span><span class="p">(</span> <span class="n">meshid</span> <span class="p">),</span>
<a name="line-53"></a>  <span class="n">m_cbp</span><span class="p">(</span> <span class="n">cbp</span> <span class="p">),</span>
<a name="line-54"></a>  <span class="n">m_cbr</span><span class="p">(</span> <span class="n">cbr</span> <span class="p">),</span>
<a name="line-55"></a>  <span class="n">m_cbs</span><span class="p">(</span> <span class="n">cbs</span> <span class="p">),</span>
<a name="line-56"></a>  <span class="n">m_host</span><span class="p">(</span> <span class="n">host</span> <span class="p">),</span>
<a name="line-57"></a>  <span class="n">m_refiner</span><span class="p">(</span> <span class="n">refiner</span> <span class="p">),</span>
<a name="line-58"></a>  <span class="n">m_sorter</span><span class="p">(</span> <span class="n">sorter</span> <span class="p">),</span>
<a name="line-59"></a>  <span class="n">m_meshwriter</span><span class="p">(</span> <span class="n">meshwriter</span> <span class="p">),</span>
<a name="line-60"></a>  <span class="n">m_scheme</span><span class="p">(</span> <span class="n">scheme</span> <span class="p">),</span>
<a name="line-61"></a>  <span class="n">m_ginpoel</span><span class="p">(),</span>
<a name="line-62"></a>  <span class="n">m_coord</span><span class="p">(),</span>
<a name="line-63"></a>  <span class="n">m_inpoel</span><span class="p">(),</span>
<a name="line-64"></a>  <span class="n">m_lid</span><span class="p">(),</span>
<a name="line-65"></a>  <span class="n">m_elemBlockId</span><span class="p">(),</span>
<a name="line-66"></a>  <span class="n">m_ndist</span><span class="p">(</span> <span class="mi">0</span> <span class="p">),</span>
<a name="line-67"></a>  <span class="n">m_nchare</span><span class="p">(</span> <span class="mi">0</span> <span class="p">),</span>
<a name="line-68"></a>  <span class="n">m_nface</span><span class="p">(),</span>
<a name="line-69"></a>  <span class="n">m_chinpoel</span><span class="p">(),</span>
<a name="line-70"></a>  <span class="n">m_chcoordmap</span><span class="p">(),</span>
<a name="line-71"></a>  <span class="n">m_chbface</span><span class="p">(),</span>
<a name="line-72"></a>  <span class="n">m_chtriinpoel</span><span class="p">(),</span>
<a name="line-73"></a>  <span class="n">m_chbnode</span><span class="p">(),</span>
<a name="line-74"></a>  <span class="n">m_chelemblockid</span><span class="p">(),</span>
<a name="line-75"></a>  <span class="n">m_bface</span><span class="p">(</span> <span class="n">bface</span> <span class="p">),</span>
<a name="line-76"></a>  <span class="n">m_bnode</span><span class="p">(</span> <span class="n">bnode</span> <span class="p">)</span>
<a name="line-77"></a><span class="c1">// *****************************************************************************</span>
<a name="line-78"></a><span class="c1">//  Constructor</span>
<a name="line-79"></a><span class="c1">//! \param[in] meshid Mesh ID</span>
<a name="line-80"></a><span class="c1">//! \param[in] filename Input mesh filename to read from</span>
<a name="line-81"></a><span class="c1">//! \param[in] cbp Charm++ callbacks for Partitioner</span>
<a name="line-82"></a><span class="c1">//! \param[in] cbr Charm++ callbacks for Refiner</span>
<a name="line-83"></a><span class="c1">//! \param[in] cbs Charm++ callbacks for Sorter</span>
<a name="line-84"></a><span class="c1">//! \param[in] host Host Charm++ proxy we are being called from</span>
<a name="line-85"></a><span class="c1">//! \param[in] refiner Mesh refiner proxy</span>
<a name="line-86"></a><span class="c1">//! \param[in] sorter Mesh reordering (sorter) proxy</span>
<a name="line-87"></a><span class="c1">//! \param[in] meshwriter Mesh writer proxy</span>
<a name="line-88"></a><span class="c1">//! \param[in] scheme Discretization scheme</span>
<a name="line-89"></a><span class="c1">//! \param[in] bface File-internal elem ids of side sets (whole mesh)</span>
<a name="line-90"></a><span class="c1">//! \param[in] faces Elem-relative face ids of side sets (whole mesh)</span>
<a name="line-91"></a><span class="c1">//! \param[in] bnode Node lists of side sets (whole mesh)</span>
<a name="line-92"></a><span class="c1">// *****************************************************************************</span>
<a name="line-93"></a><span class="p">{</span>
<a name="line-94"></a>  <span class="c1">// The following call has to be made on all MPI ranks immediately after</span>
<a name="line-95"></a>  <span class="c1">// initializing MPI. This has to be done from a Charm++ nodegroup, since there</span>
<a name="line-96"></a>  <span class="c1">// exists only one rank per node on a nodegroup, in SMP mode.</span>
<a name="line-97"></a>  <span class="c1">// see https://github.com/trilinos/Trilinos/issues/11197#issuecomment-1301325163</span>
<a name="line-98"></a>  <span class="n">Kokkos</span><span class="o">::</span><span class="n">initialize</span><span class="p">();</span>
<a name="line-99"></a>
<a name="line-100"></a>  <span class="c1">// Create mesh reader</span>
<a name="line-101"></a>  <span class="n">tk</span><span class="o">::</span><span class="n">MeshReader</span> <span class="n">mr</span><span class="p">(</span> <span class="n">filename</span> <span class="p">);</span>
<a name="line-102"></a>
<a name="line-103"></a>  <span class="c1">// Read this compute node&#39;s chunk of the mesh (graph and coords) from file</span>
<a name="line-104"></a>  <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span> <span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="o">&gt;</span> <span class="n">triinpoel</span><span class="p">;</span>
<a name="line-105"></a>  <span class="n">mr</span><span class="p">.</span><span class="n">readMeshPart</span><span class="p">(</span> <span class="n">m_ginpoel</span><span class="p">,</span> <span class="n">m_inpoel</span><span class="p">,</span> <span class="n">triinpoel</span><span class="p">,</span> <span class="n">m_lid</span><span class="p">,</span> <span class="n">m_coord</span><span class="p">,</span>
<a name="line-106"></a>                   <span class="n">m_elemBlockId</span><span class="p">,</span> <span class="n">CkNumNodes</span><span class="p">(),</span> <span class="n">CkMyNode</span><span class="p">()</span> <span class="p">);</span>
<a name="line-107"></a>
<a name="line-108"></a>  <span class="c1">// Compute triangle connectivity for side sets, reduce boundary face for side</span>
<a name="line-109"></a>  <span class="c1">// sets to this compute node only and to compute-node-local face ids</span>
<a name="line-110"></a>  <span class="n">m_triinpoel</span> <span class="o">=</span> <span class="n">mr</span><span class="p">.</span><span class="n">triinpoel</span><span class="p">(</span> <span class="n">m_bface</span><span class="p">,</span> <span class="n">faces</span><span class="p">,</span> <span class="n">m_ginpoel</span><span class="p">,</span> <span class="n">triinpoel</span> <span class="p">);</span>
<a name="line-111"></a>
<a name="line-112"></a>  <span class="c1">// Reduce boundary node lists (global ids) for side sets to this compute node</span>
<a name="line-113"></a>  <span class="c1">// only</span>
<a name="line-114"></a>  <span class="n">ownBndNodes</span><span class="p">(</span> <span class="n">m_lid</span><span class="p">,</span> <span class="n">m_bnode</span> <span class="p">);</span>
<a name="line-115"></a>
<a name="line-116"></a>  <span class="c1">// Sum number of cells across distributed mesh</span>
<a name="line-117"></a>  <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span> <span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="o">&gt;</span> <span class="n">meshdata</span><span class="p">{</span> <span class="n">meshid</span><span class="p">,</span> <span class="n">m_ginpoel</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="o">/</span><span class="mi">4</span> <span class="p">};</span>
<a name="line-118"></a>  <span class="n">contribute</span><span class="p">(</span> <span class="n">meshdata</span><span class="p">,</span> <span class="n">CkReduction</span><span class="o">::</span><span class="n">sum_ulong</span><span class="p">,</span> <span class="n">m_cbp</span><span class="p">.</span><span class="n">get</span><span class="o">&lt;</span> <span class="n">tag</span><span class="o">::</span><span class="n">load</span> <span class="o">&gt;</span><span class="p">()</span> <span class="p">);</span>
<a name="line-119"></a><span class="p">}</span>
<a name="line-120"></a>
<a name="line-121"></a><span class="kt">void</span>
<a name="line-122"></a><span class="n">Partitioner</span><span class="o">::</span><span class="n">ownBndNodes</span><span class="p">(</span>
<a name="line-123"></a>  <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">unordered_map</span><span class="o">&lt;</span> <span class="n">std</span><span class="o">::</span><span class="kt">size_t</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="o">&gt;&amp;</span> <span class="n">lid</span><span class="p">,</span>
<a name="line-124"></a>  <span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span> <span class="kt">int</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span> <span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="o">&gt;</span> <span class="o">&gt;&amp;</span> <span class="n">bnode</span> <span class="p">)</span>
<a name="line-125"></a><span class="c1">// *****************************************************************************</span>
<a name="line-126"></a><span class="c1">// Keep only those nodes for side sets that reside on this compute node</span>
<a name="line-127"></a><span class="c1">//! \param[in] lid Global-&gt;local node IDs of elements of this compute node&#39;s</span>
<a name="line-128"></a><span class="c1">//!   mesh chunk</span>
<a name="line-129"></a><span class="c1">//! \param[in,out] bnode Global ids of nodes for side sets for whole mesh</span>
<a name="line-130"></a><span class="c1">//! \details This function overwrites the input boundary node lists map with the</span>
<a name="line-131"></a><span class="c1">//!    nodes that reside on the caller compute node.</span>
<a name="line-132"></a><span class="c1">// *****************************************************************************</span>
<a name="line-133"></a><span class="p">{</span>
<a name="line-134"></a>  <span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span> <span class="kt">int</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span> <span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="o">&gt;</span> <span class="o">&gt;</span> <span class="n">bnode_own</span><span class="p">;</span>
<a name="line-135"></a>
<a name="line-136"></a>  <span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="p">[</span> <span class="n">setid</span><span class="p">,</span> <span class="n">nodes</span> <span class="p">]</span> <span class="o">:</span> <span class="n">bnode</span><span class="p">)</span> <span class="p">{</span>
<a name="line-137"></a>    <span class="k">auto</span><span class="o">&amp;</span> <span class="n">b</span> <span class="o">=</span> <span class="n">bnode_own</span><span class="p">[</span> <span class="n">setid</span> <span class="p">];</span>
<a name="line-138"></a>    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="nl">n</span> <span class="p">:</span> <span class="n">nodes</span><span class="p">)</span> <span class="p">{</span>
<a name="line-139"></a>      <span class="k">auto</span> <span class="n">i</span> <span class="o">=</span> <span class="n">lid</span><span class="p">.</span><span class="n">find</span><span class="p">(</span> <span class="n">n</span> <span class="p">);</span>
<a name="line-140"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="n">end</span><span class="p">(</span><span class="n">lid</span><span class="p">))</span> <span class="n">b</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span> <span class="n">n</span> <span class="p">);</span>
<a name="line-141"></a>    <span class="p">}</span>
<a name="line-142"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">b</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span> <span class="n">bnode_own</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span> <span class="n">setid</span> <span class="p">);</span>
<a name="line-143"></a>  <span class="p">}</span>
<a name="line-144"></a>
<a name="line-145"></a>  <span class="n">bnode</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">bnode_own</span><span class="p">);</span>
<a name="line-146"></a><span class="p">}</span>
<a name="line-147"></a>
<a name="line-148"></a><span class="kt">void</span>
<a name="line-149"></a><span class="n">Partitioner</span><span class="o">::</span><span class="n">partition</span><span class="p">(</span> <span class="kt">int</span> <span class="n">nchare</span> <span class="p">)</span>
<a name="line-150"></a><span class="c1">// *****************************************************************************</span>
<a name="line-151"></a><span class="c1">//  Partition the computational mesh into a number of chares</span>
<a name="line-152"></a><span class="c1">//! \param[in] nchare Number of parts the mesh will be partitioned into</span>
<a name="line-153"></a><span class="c1">//! \details This function calls the mesh partitioner to partition the mesh. The</span>
<a name="line-154"></a><span class="c1">//!   number of partitions equals the number nchare argument which must be no</span>
<a name="line-155"></a><span class="c1">//!   lower than the number of compute nodes.</span>
<a name="line-156"></a><span class="c1">// *****************************************************************************</span>
<a name="line-157"></a><span class="p">{</span>
<a name="line-158"></a>  <span class="n">Assert</span><span class="p">(</span> <span class="n">nchare</span> <span class="o">&gt;=</span> <span class="n">CkNumNodes</span><span class="p">(),</span> <span class="s">&quot;Number of chares must not be lower than the &quot;</span>
<a name="line-159"></a>                                  <span class="s">&quot;number of compute nodes&quot;</span> <span class="p">);</span>
<a name="line-160"></a>
<a name="line-161"></a>  <span class="c1">// Generate element IDs for Zoltan</span>
<a name="line-162"></a>  <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span> <span class="kt">long</span> <span class="kt">long</span> <span class="o">&gt;</span> <span class="n">gelemid</span><span class="p">(</span> <span class="n">m_ginpoel</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="o">/</span><span class="mi">4</span> <span class="p">);</span>
<a name="line-163"></a>  <span class="n">std</span><span class="o">::</span><span class="n">iota</span><span class="p">(</span> <span class="n">begin</span><span class="p">(</span><span class="n">gelemid</span><span class="p">),</span> <span class="n">end</span><span class="p">(</span><span class="n">gelemid</span><span class="p">),</span> <span class="mi">0</span> <span class="p">);</span>
<a name="line-164"></a>
<a name="line-165"></a>  <span class="n">m_nchare</span> <span class="o">=</span> <span class="n">nchare</span><span class="p">;</span>
<a name="line-166"></a>  <span class="k">const</span> <span class="k">auto</span> <span class="n">alg</span> <span class="o">=</span> <span class="n">g_inputdeck</span><span class="p">.</span><span class="n">get</span><span class="o">&lt;</span> <span class="n">tag</span><span class="o">::</span><span class="n">selected</span><span class="p">,</span> <span class="n">tag</span><span class="o">::</span><span class="n">partitioner</span> <span class="o">&gt;</span><span class="p">();</span>
<a name="line-167"></a>  <span class="k">const</span> <span class="k">auto</span> <span class="n">che</span> <span class="o">=</span> <span class="n">tk</span><span class="o">::</span><span class="n">zoltan</span><span class="o">::</span><span class="n">geomPartMesh</span><span class="p">(</span> <span class="n">alg</span><span class="p">,</span>
<a name="line-168"></a>                                             <span class="n">centroids</span><span class="p">(</span> <span class="n">m_inpoel</span><span class="p">,</span> <span class="n">m_coord</span> <span class="p">),</span>
<a name="line-169"></a>                                             <span class="n">gelemid</span><span class="p">,</span>
<a name="line-170"></a>                                             <span class="n">nchare</span> <span class="p">);</span>
<a name="line-171"></a>
<a name="line-172"></a>  <span class="k">if</span> <span class="p">(</span> <span class="n">g_inputdeck</span><span class="p">.</span><span class="n">get</span><span class="o">&lt;</span> <span class="n">tag</span><span class="o">::</span><span class="n">cmd</span><span class="p">,</span> <span class="n">tag</span><span class="o">::</span><span class="n">feedback</span> <span class="o">&gt;</span><span class="p">()</span> <span class="p">)</span> <span class="n">m_host</span><span class="p">.</span><span class="n">pepartitioned</span><span class="p">();</span>
<a name="line-173"></a>
<a name="line-174"></a>  <span class="n">contribute</span><span class="p">(</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="kt">size_t</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">m_meshid</span><span class="p">,</span> <span class="n">CkReduction</span><span class="o">::</span><span class="n">nop</span><span class="p">,</span>
<a name="line-175"></a>              <span class="n">m_cbp</span><span class="p">.</span><span class="n">get</span><span class="o">&lt;</span> <span class="n">tag</span><span class="o">::</span><span class="n">partitioned</span> <span class="o">&gt;</span><span class="p">()</span> <span class="p">);</span>
<a name="line-176"></a>
<a name="line-177"></a>  <span class="n">Assert</span><span class="p">(</span> <span class="n">che</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">==</span> <span class="n">gelemid</span><span class="p">.</span><span class="n">size</span><span class="p">(),</span> <span class="s">&quot;Size of ownership array (chare ID &quot;</span>
<a name="line-178"></a>          <span class="s">&quot;of elements) after mesh partitioning does not equal the number of &quot;</span>
<a name="line-179"></a>          <span class="s">&quot;mesh graph elements&quot;</span> <span class="p">);</span>
<a name="line-180"></a>
<a name="line-181"></a>  <span class="c1">// Categorize mesh elements (given by their gobal node IDs) by target chare</span>
<a name="line-182"></a>  <span class="c1">// and distribute to their compute nodes based on mesh partitioning.</span>
<a name="line-183"></a>  <span class="n">distribute</span><span class="p">(</span> <span class="n">categorize</span><span class="p">(</span> <span class="n">che</span> <span class="p">)</span> <span class="p">);</span>
<a name="line-184"></a><span class="p">}</span>
<a name="line-185"></a>
<a name="line-186"></a><span class="kt">void</span>
<a name="line-187"></a><span class="n">Partitioner</span><span class="o">::</span><span class="n">addMesh</span><span class="p">(</span>
<a name="line-188"></a>  <span class="kt">int</span> <span class="n">fromnode</span><span class="p">,</span>
<a name="line-189"></a>  <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">unordered_map</span><span class="o">&lt;</span> <span class="kt">int</span><span class="p">,</span>        <span class="c1">// chare id</span>
<a name="line-190"></a>          <span class="n">std</span><span class="o">::</span><span class="n">tuple</span><span class="o">&lt;</span>
<a name="line-191"></a>            <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span> <span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="o">&gt;</span><span class="p">,</span> <span class="c1">// tet connectivity</span>
<a name="line-192"></a>            <span class="n">tk</span><span class="o">::</span><span class="n">UnsMesh</span><span class="o">::</span><span class="n">CoordMap</span><span class="p">,</span>      <span class="c1">// node coords</span>
<a name="line-193"></a>            <span class="n">std</span><span class="o">::</span><span class="n">unordered_map</span><span class="o">&lt;</span> <span class="kt">int</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span> <span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="o">&gt;</span> <span class="o">&gt;</span><span class="p">,</span> <span class="c1">// bface conn</span>
<a name="line-194"></a>            <span class="n">std</span><span class="o">::</span><span class="n">unordered_map</span><span class="o">&lt;</span> <span class="kt">int</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span> <span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="o">&gt;</span> <span class="o">&gt;</span><span class="p">,</span> <span class="c1">// bnodes</span>
<a name="line-195"></a>            <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span> <span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="o">&gt;</span>          <span class="c1">// elem-blocks</span>
<a name="line-196"></a>          <span class="o">&gt;</span> <span class="o">&gt;&amp;</span> <span class="n">chmesh</span> <span class="p">)</span>
<a name="line-197"></a><span class="c1">// *****************************************************************************</span>
<a name="line-198"></a><span class="c1">//  Receive mesh associated to chares we own after refinement</span>
<a name="line-199"></a><span class="c1">//! \param[in] fromnode Compute node call coming from</span>
<a name="line-200"></a><span class="c1">//! \param[in] chmesh Map associating mesh connectivities to global node ids</span>
<a name="line-201"></a><span class="c1">//!   and node coordinates for mesh chunks we are assigned by the partitioner</span>
<a name="line-202"></a><span class="c1">// *****************************************************************************</span>
<a name="line-203"></a><span class="p">{</span>
<a name="line-204"></a>  <span class="c1">// Store mesh connectivity and global node coordinates categorized by chares.</span>
<a name="line-205"></a>  <span class="c1">// The send side also writes to the data written here, so concat.</span>
<a name="line-206"></a>  <span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="p">[</span> <span class="n">chareid</span><span class="p">,</span> <span class="n">chunk</span> <span class="p">]</span> <span class="o">:</span> <span class="n">chmesh</span><span class="p">)</span> <span class="p">{</span>
<a name="line-207"></a>    <span class="n">Assert</span><span class="p">(</span> <span class="n">node</span><span class="p">(</span><span class="n">chareid</span><span class="p">)</span> <span class="o">==</span> <span class="n">CkMyNode</span><span class="p">(),</span> <span class="s">&quot;Compute node &quot;</span>
<a name="line-208"></a>            <span class="o">+</span> <span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">CkMyNode</span><span class="p">())</span> <span class="o">+</span>
<a name="line-209"></a>            <span class="s">&quot; received a mesh whose chare it does not own&quot;</span> <span class="p">);</span>
<a name="line-210"></a>    <span class="c1">// Store domain element (tetrahedron) connectivity</span>
<a name="line-211"></a>    <span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="n">inpoel</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">get</span><span class="o">&lt;</span> <span class="mi">0</span> <span class="o">&gt;</span><span class="p">(</span> <span class="n">chunk</span> <span class="p">);</span>
<a name="line-212"></a>    <span class="k">auto</span><span class="o">&amp;</span> <span class="n">inp</span> <span class="o">=</span> <span class="n">m_chinpoel</span><span class="p">[</span> <span class="n">chareid</span> <span class="p">];</span>  <span class="c1">// will store tetrahedron connectivity</span>
<a name="line-213"></a>    <span class="n">inp</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span> <span class="n">end</span><span class="p">(</span><span class="n">inp</span><span class="p">),</span> <span class="n">begin</span><span class="p">(</span><span class="n">inpoel</span><span class="p">),</span> <span class="n">end</span><span class="p">(</span><span class="n">inpoel</span><span class="p">)</span> <span class="p">);</span>
<a name="line-214"></a>    <span class="c1">// Store own mesh block id and associated tet ids</span>
<a name="line-215"></a>    <span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="n">elblock</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">get</span><span class="o">&lt;</span><span class="mi">4</span><span class="o">&gt;</span><span class="p">(</span> <span class="n">chunk</span> <span class="p">);</span>
<a name="line-216"></a>    <span class="k">auto</span><span class="o">&amp;</span> <span class="n">cheb</span> <span class="o">=</span> <span class="n">m_chelemblockid</span><span class="p">[</span> <span class="n">chareid</span> <span class="p">];</span>
<a name="line-217"></a>    <span class="n">cheb</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span> <span class="n">end</span><span class="p">(</span><span class="n">cheb</span><span class="p">),</span> <span class="n">begin</span><span class="p">(</span><span class="n">elblock</span><span class="p">),</span> <span class="n">end</span><span class="p">(</span><span class="n">elblock</span><span class="p">)</span> <span class="p">);</span>
<a name="line-218"></a>    <span class="c1">// Store mesh node coordinates associated to global node IDs</span>
<a name="line-219"></a>    <span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="n">coord</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">get</span><span class="o">&lt;</span> <span class="mi">1</span> <span class="o">&gt;</span><span class="p">(</span> <span class="n">chunk</span> <span class="p">);</span>
<a name="line-220"></a>    <span class="n">Assert</span><span class="p">(</span> <span class="n">tk</span><span class="o">::</span><span class="n">uniquecopy</span><span class="p">(</span><span class="n">inpoel</span><span class="p">).</span><span class="n">size</span><span class="p">()</span> <span class="o">==</span> <span class="n">coord</span><span class="p">.</span><span class="n">size</span><span class="p">(),</span> <span class="s">&quot;Size mismatch&quot;</span> <span class="p">);</span>
<a name="line-221"></a>    <span class="k">auto</span><span class="o">&amp;</span> <span class="n">chcm</span> <span class="o">=</span> <span class="n">m_chcoordmap</span><span class="p">[</span> <span class="n">chareid</span> <span class="p">];</span>     <span class="c1">// will store node coordinates</span>
<a name="line-222"></a>    <span class="n">chcm</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span> <span class="n">begin</span><span class="p">(</span><span class="n">coord</span><span class="p">),</span> <span class="n">end</span><span class="p">(</span><span class="n">coord</span><span class="p">)</span> <span class="p">);</span>  <span class="c1">// concatenate node coords</span>
<a name="line-223"></a>    <span class="c1">// Store boundary side set id + face ids + face connectivities</span>
<a name="line-224"></a>    <span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="n">bconn</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">get</span><span class="o">&lt;</span> <span class="mi">2</span> <span class="o">&gt;</span><span class="p">(</span> <span class="n">chunk</span> <span class="p">);</span>
<a name="line-225"></a>    <span class="k">auto</span><span class="o">&amp;</span> <span class="n">bface</span> <span class="o">=</span> <span class="n">m_chbface</span><span class="p">[</span> <span class="n">chareid</span> <span class="p">];</span>  <span class="c1">// for side set id + boundary face ids</span>
<a name="line-226"></a>    <span class="k">auto</span><span class="o">&amp;</span> <span class="n">t</span> <span class="o">=</span> <span class="n">m_chtriinpoel</span><span class="p">[</span> <span class="n">chareid</span> <span class="p">];</span>  <span class="c1">// for boundary face connectivity</span>
<a name="line-227"></a>    <span class="k">auto</span><span class="o">&amp;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">m_nface</span><span class="p">[</span> <span class="n">chareid</span> <span class="p">];</span>        <span class="c1">// use counter for chare</span>
<a name="line-228"></a>    <span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="p">[</span> <span class="n">setid</span><span class="p">,</span> <span class="n">faceids</span> <span class="p">]</span> <span class="o">:</span> <span class="n">bconn</span><span class="p">)</span> <span class="p">{</span>
<a name="line-229"></a>      <span class="k">auto</span><span class="o">&amp;</span> <span class="n">b</span> <span class="o">=</span> <span class="n">bface</span><span class="p">[</span> <span class="n">setid</span> <span class="p">];</span>
<a name="line-230"></a>      <span class="k">for</span> <span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">faceids</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="o">/</span><span class="mi">3</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
<a name="line-231"></a>        <span class="n">b</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span> <span class="n">f</span><span class="o">++</span> <span class="p">);</span>
<a name="line-232"></a>        <span class="n">t</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span> <span class="n">faceids</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="mi">3</span><span class="o">+</span><span class="mi">0</span><span class="p">]</span> <span class="p">);</span>
<a name="line-233"></a>        <span class="n">t</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span> <span class="n">faceids</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="mi">3</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="p">);</span>
<a name="line-234"></a>        <span class="n">t</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span> <span class="n">faceids</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="mi">3</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="p">);</span>
<a name="line-235"></a>      <span class="p">}</span>
<a name="line-236"></a>    <span class="p">}</span>
<a name="line-237"></a>    <span class="c1">// Store boundary side set id + node lists</span>
<a name="line-238"></a>    <span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="n">bnode</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">get</span><span class="o">&lt;</span> <span class="mi">3</span> <span class="o">&gt;</span><span class="p">(</span> <span class="n">chunk</span> <span class="p">);</span>
<a name="line-239"></a>    <span class="k">auto</span><span class="o">&amp;</span> <span class="n">nodes</span> <span class="o">=</span> <span class="n">m_chbnode</span><span class="p">[</span> <span class="n">chareid</span> <span class="p">];</span>  <span class="c1">// for side set id + boundary nodes</span>
<a name="line-240"></a>    <span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="p">[</span> <span class="n">setid</span><span class="p">,</span> <span class="n">bnodes</span> <span class="p">]</span> <span class="o">:</span> <span class="n">bnode</span><span class="p">)</span> <span class="p">{</span>
<a name="line-241"></a>      <span class="k">auto</span><span class="o">&amp;</span> <span class="n">b</span> <span class="o">=</span> <span class="n">nodes</span><span class="p">[</span> <span class="n">setid</span> <span class="p">];</span>
<a name="line-242"></a>      <span class="n">b</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span> <span class="n">end</span><span class="p">(</span><span class="n">b</span><span class="p">),</span> <span class="n">begin</span><span class="p">(</span><span class="n">bnodes</span><span class="p">),</span> <span class="n">end</span><span class="p">(</span><span class="n">bnodes</span><span class="p">)</span> <span class="p">);</span>
<a name="line-243"></a>    <span class="p">}</span>
<a name="line-244"></a>  <span class="p">}</span>
<a name="line-245"></a>
<a name="line-246"></a>  <span class="n">thisProxy</span><span class="p">[</span> <span class="n">fromnode</span> <span class="p">].</span><span class="n">recvMesh</span><span class="p">();</span>
<a name="line-247"></a><span class="p">}</span>
<a name="line-248"></a>
<a name="line-249"></a><span class="kt">int</span>
<a name="line-250"></a><span class="n">Partitioner</span><span class="o">::</span><span class="n">node</span><span class="p">(</span> <span class="kt">int</span> <span class="n">id</span> <span class="p">)</span> <span class="k">const</span>
<a name="line-251"></a><span class="c1">// *****************************************************************************</span>
<a name="line-252"></a><span class="c1">//  Return nodegroup id for chare id</span>
<a name="line-253"></a><span class="c1">//! \param[in] id Chare id</span>
<a name="line-254"></a><span class="c1">//! \return Nodegroup that creates the chare</span>
<a name="line-255"></a><span class="c1">//! \details This is computed based on a simple contiguous linear</span>
<a name="line-256"></a><span class="c1">//!   distribution of chare ids to compute nodes.</span>
<a name="line-257"></a><span class="c1">// *****************************************************************************</span>
<a name="line-258"></a><span class="p">{</span>
<a name="line-259"></a>  <span class="n">Assert</span><span class="p">(</span> <span class="n">m_nchare</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;Number of chares must be a positive number&quot;</span> <span class="p">);</span>
<a name="line-260"></a>  <span class="k">auto</span> <span class="n">p</span> <span class="o">=</span> <span class="n">id</span> <span class="o">/</span> <span class="p">(</span><span class="n">m_nchare</span> <span class="o">/</span> <span class="n">CkNumNodes</span><span class="p">());</span>
<a name="line-261"></a>  <span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">&gt;=</span> <span class="n">CkNumNodes</span><span class="p">())</span> <span class="n">p</span> <span class="o">=</span> <span class="n">CkNumNodes</span><span class="p">()</span><span class="mi">-1</span><span class="p">;</span>
<a name="line-262"></a>  <span class="n">Assert</span><span class="p">(</span> <span class="n">p</span> <span class="o">&lt;</span> <span class="n">CkNumNodes</span><span class="p">(),</span> <span class="s">&quot;Assigning to nonexistent node&quot;</span> <span class="p">);</span>
<a name="line-263"></a>  <span class="k">return</span> <span class="n">p</span><span class="p">;</span>
<a name="line-264"></a><span class="p">}</span>
<a name="line-265"></a>
<a name="line-266"></a><span class="kt">void</span>
<a name="line-267"></a><span class="n">Partitioner</span><span class="o">::</span><span class="n">recvMesh</span><span class="p">()</span>
<a name="line-268"></a><span class="c1">// *****************************************************************************</span>
<a name="line-269"></a><span class="c1">//  Acknowledge received mesh chunk and its nodes after mesh refinement</span>
<a name="line-270"></a><span class="c1">// *****************************************************************************</span>
<a name="line-271"></a><span class="p">{</span>
<a name="line-272"></a>  <span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">m_ndist</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<a name="line-273"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">g_inputdeck</span><span class="p">.</span><span class="n">get</span><span class="o">&lt;</span> <span class="n">tag</span><span class="o">::</span><span class="n">cmd</span><span class="p">,</span> <span class="n">tag</span><span class="o">::</span><span class="n">feedback</span> <span class="o">&gt;</span><span class="p">())</span> <span class="n">m_host</span><span class="p">.</span><span class="n">pedistributed</span><span class="p">();</span>
<a name="line-274"></a>    <span class="n">contribute</span><span class="p">(</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="kt">size_t</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">m_meshid</span><span class="p">,</span> <span class="n">CkReduction</span><span class="o">::</span><span class="n">nop</span><span class="p">,</span>
<a name="line-275"></a>                <span class="n">m_cbp</span><span class="p">.</span><span class="n">get</span><span class="o">&lt;</span> <span class="n">tag</span><span class="o">::</span><span class="n">distributed</span> <span class="o">&gt;</span><span class="p">()</span> <span class="p">);</span>
<a name="line-276"></a>  <span class="p">}</span>
<a name="line-277"></a><span class="p">}</span>
<a name="line-278"></a>
<a name="line-279"></a><span class="kt">void</span>
<a name="line-280"></a><span class="n">Partitioner</span><span class="o">::</span><span class="n">refine</span><span class="p">()</span>
<a name="line-281"></a><span class="c1">// *****************************************************************************</span>
<a name="line-282"></a><span class="c1">// Optionally start refining the mesh</span>
<a name="line-283"></a><span class="c1">// *****************************************************************************</span>
<a name="line-284"></a><span class="p">{</span>
<a name="line-285"></a>  <span class="k">auto</span> <span class="n">dist</span> <span class="o">=</span> <span class="n">distribution</span><span class="p">(</span> <span class="n">m_nchare</span> <span class="p">);</span>
<a name="line-286"></a>
<a name="line-287"></a>  <span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="line-288"></a>  <span class="k">if</span> <span class="p">(</span><span class="n">m_chinpoel</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">&lt;</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="kt">size_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">dist</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="p">{</span>
<a name="line-289"></a>
<a name="line-290"></a>    <span class="n">error</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="line-291"></a>
<a name="line-292"></a>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="line-293"></a>
<a name="line-294"></a>    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">c</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">c</span><span class="o">&lt;</span><span class="n">dist</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span> <span class="o">++</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
<a name="line-295"></a>      <span class="c1">// compute chare ID</span>
<a name="line-296"></a>      <span class="k">auto</span> <span class="n">cid</span> <span class="o">=</span> <span class="n">CkMyNode</span><span class="p">()</span> <span class="o">*</span> <span class="n">dist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">c</span><span class="p">;</span>
<a name="line-297"></a>
<a name="line-298"></a>      <span class="n">Assert</span><span class="p">(</span><span class="n">tk</span><span class="o">::</span><span class="n">cref_find</span><span class="p">(</span><span class="n">m_chinpoel</span><span class="p">,</span><span class="n">cid</span><span class="p">).</span><span class="n">size</span><span class="p">()</span><span class="o">/</span><span class="mi">4</span> <span class="o">==</span>
<a name="line-299"></a>        <span class="n">tk</span><span class="o">::</span><span class="n">cref_find</span><span class="p">(</span><span class="n">m_chelemblockid</span><span class="p">,</span><span class="n">cid</span><span class="p">).</span><span class="n">size</span><span class="p">(),</span>
<a name="line-300"></a>        <span class="s">&quot;incorrect number of elements in elem-block id vector&quot;</span><span class="p">);</span>
<a name="line-301"></a>      <span class="c1">// create refiner Charm++ chare array element using dynamic insertion</span>
<a name="line-302"></a>      <span class="n">m_refiner</span><span class="p">[</span> <span class="n">cid</span> <span class="p">].</span><span class="n">insert</span><span class="p">(</span> <span class="n">m_meshid</span><span class="p">,</span>
<a name="line-303"></a>                               <span class="n">m_host</span><span class="p">,</span>
<a name="line-304"></a>                               <span class="n">m_sorter</span><span class="p">,</span>
<a name="line-305"></a>                               <span class="n">m_meshwriter</span><span class="p">,</span>
<a name="line-306"></a>                               <span class="n">m_scheme</span><span class="p">,</span>
<a name="line-307"></a>                               <span class="n">m_cbr</span><span class="p">,</span>
<a name="line-308"></a>                               <span class="n">m_cbs</span><span class="p">,</span>
<a name="line-309"></a>                               <span class="n">tk</span><span class="o">::</span><span class="n">cref_find</span><span class="p">(</span><span class="n">m_chinpoel</span><span class="p">,</span><span class="n">cid</span><span class="p">),</span>
<a name="line-310"></a>                               <span class="n">tk</span><span class="o">::</span><span class="n">cref_find</span><span class="p">(</span><span class="n">m_chcoordmap</span><span class="p">,</span><span class="n">cid</span><span class="p">),</span>
<a name="line-311"></a>                               <span class="n">tk</span><span class="o">::</span><span class="n">cref_find</span><span class="p">(</span><span class="n">m_chbface</span><span class="p">,</span><span class="n">cid</span><span class="p">),</span>
<a name="line-312"></a>                               <span class="n">tk</span><span class="o">::</span><span class="n">cref_find</span><span class="p">(</span><span class="n">m_chtriinpoel</span><span class="p">,</span><span class="n">cid</span><span class="p">),</span>
<a name="line-313"></a>                               <span class="n">tk</span><span class="o">::</span><span class="n">cref_find</span><span class="p">(</span><span class="n">m_chbnode</span><span class="p">,</span><span class="n">cid</span><span class="p">),</span>
<a name="line-314"></a>                               <span class="n">tk</span><span class="o">::</span><span class="n">cref_find</span><span class="p">(</span><span class="n">m_chelemblockid</span><span class="p">,</span><span class="n">cid</span><span class="p">),</span>
<a name="line-315"></a>                               <span class="n">m_nchare</span> <span class="p">);</span>
<a name="line-316"></a>    <span class="p">}</span>
<a name="line-317"></a>
<a name="line-318"></a>  <span class="p">}</span>
<a name="line-319"></a>
<a name="line-320"></a>  <span class="n">tk</span><span class="o">::</span><span class="n">destroy</span><span class="p">(</span> <span class="n">m_ginpoel</span> <span class="p">);</span>
<a name="line-321"></a>  <span class="n">tk</span><span class="o">::</span><span class="n">destroy</span><span class="p">(</span> <span class="n">m_coord</span> <span class="p">);</span>
<a name="line-322"></a>  <span class="n">tk</span><span class="o">::</span><span class="n">destroy</span><span class="p">(</span> <span class="n">m_inpoel</span> <span class="p">);</span>
<a name="line-323"></a>  <span class="n">tk</span><span class="o">::</span><span class="n">destroy</span><span class="p">(</span> <span class="n">m_lid</span> <span class="p">);</span>
<a name="line-324"></a>  <span class="n">tk</span><span class="o">::</span><span class="n">destroy</span><span class="p">(</span> <span class="n">m_elemBlockId</span> <span class="p">);</span>
<a name="line-325"></a>  <span class="n">tk</span><span class="o">::</span><span class="n">destroy</span><span class="p">(</span> <span class="n">m_nface</span> <span class="p">);</span>
<a name="line-326"></a>  <span class="n">tk</span><span class="o">::</span><span class="n">destroy</span><span class="p">(</span> <span class="n">m_nodech</span> <span class="p">);</span>
<a name="line-327"></a>  <span class="n">tk</span><span class="o">::</span><span class="n">destroy</span><span class="p">(</span> <span class="n">m_linnodes</span> <span class="p">);</span>
<a name="line-328"></a>  <span class="n">tk</span><span class="o">::</span><span class="n">destroy</span><span class="p">(</span> <span class="n">m_chinpoel</span> <span class="p">);</span>
<a name="line-329"></a>  <span class="n">tk</span><span class="o">::</span><span class="n">destroy</span><span class="p">(</span> <span class="n">m_chcoordmap</span> <span class="p">);</span>
<a name="line-330"></a>  <span class="n">tk</span><span class="o">::</span><span class="n">destroy</span><span class="p">(</span> <span class="n">m_chbface</span> <span class="p">);</span>
<a name="line-331"></a>  <span class="n">tk</span><span class="o">::</span><span class="n">destroy</span><span class="p">(</span> <span class="n">m_chtriinpoel</span> <span class="p">);</span>
<a name="line-332"></a>  <span class="n">tk</span><span class="o">::</span><span class="n">destroy</span><span class="p">(</span> <span class="n">m_chbnode</span> <span class="p">);</span>
<a name="line-333"></a>  <span class="n">tk</span><span class="o">::</span><span class="n">destroy</span><span class="p">(</span> <span class="n">m_chelemblockid</span> <span class="p">);</span>
<a name="line-334"></a>  <span class="n">tk</span><span class="o">::</span><span class="n">destroy</span><span class="p">(</span> <span class="n">m_bnodechares</span> <span class="p">);</span>
<a name="line-335"></a>  <span class="n">tk</span><span class="o">::</span><span class="n">destroy</span><span class="p">(</span> <span class="n">m_bface</span> <span class="p">);</span>
<a name="line-336"></a>  <span class="n">tk</span><span class="o">::</span><span class="n">destroy</span><span class="p">(</span> <span class="n">m_triinpoel</span> <span class="p">);</span>
<a name="line-337"></a>  <span class="n">tk</span><span class="o">::</span><span class="n">destroy</span><span class="p">(</span> <span class="n">m_bnode</span> <span class="p">);</span>
<a name="line-338"></a>
<a name="line-339"></a>  <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span> <span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="o">&gt;</span> <span class="n">meshdata</span><span class="p">{</span> <span class="n">m_meshid</span><span class="p">,</span> <span class="n">error</span> <span class="p">};</span>
<a name="line-340"></a>  <span class="n">contribute</span><span class="p">(</span> <span class="n">meshdata</span><span class="p">,</span> <span class="n">CkReduction</span><span class="o">::</span><span class="n">max_ulong</span><span class="p">,</span> <span class="n">m_cbp</span><span class="p">.</span><span class="n">get</span><span class="o">&lt;</span><span class="n">tag</span><span class="o">::</span><span class="n">refinserted</span><span class="o">&gt;</span><span class="p">()</span> <span class="p">);</span>
<a name="line-341"></a><span class="p">}</span>
<a name="line-342"></a>
<a name="line-343"></a><span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="o">&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span> <span class="n">tk</span><span class="o">::</span><span class="n">real</span> <span class="o">&gt;</span><span class="p">,</span> <span class="mi">3</span> <span class="o">&gt;</span>
<a name="line-344"></a><span class="n">Partitioner</span><span class="o">::</span><span class="n">centroids</span><span class="p">(</span> <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span> <span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="o">&gt;&amp;</span> <span class="n">inpoel</span><span class="p">,</span>
<a name="line-345"></a>                        <span class="k">const</span> <span class="n">tk</span><span class="o">::</span><span class="n">UnsMesh</span><span class="o">::</span><span class="n">Coords</span><span class="o">&amp;</span> <span class="n">coord</span> <span class="p">)</span>
<a name="line-346"></a><span class="c1">// *****************************************************************************</span>
<a name="line-347"></a><span class="c1">//  Compute element centroid coordinates</span>
<a name="line-348"></a><span class="c1">//! \param[in] inpoel Mesh connectivity with local ids</span>
<a name="line-349"></a><span class="c1">//! \param[in] coord Node coordinates</span>
<a name="line-350"></a><span class="c1">//! \return Centroids for all cells on this compute node</span>
<a name="line-351"></a><span class="c1">// *****************************************************************************</span>
<a name="line-352"></a><span class="p">{</span>
<a name="line-353"></a>  <span class="n">Assert</span><span class="p">(</span> <span class="n">tk</span><span class="o">::</span><span class="n">uniquecopy</span><span class="p">(</span><span class="n">inpoel</span><span class="p">).</span><span class="n">size</span><span class="p">()</span> <span class="o">==</span> <span class="n">coord</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">size</span><span class="p">(),</span> <span class="s">&quot;Size mismatch&quot;</span> <span class="p">);</span>
<a name="line-354"></a>
<a name="line-355"></a>  <span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">coord</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<a name="line-356"></a>  <span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="n">y</span> <span class="o">=</span> <span class="n">coord</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<a name="line-357"></a>  <span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="n">z</span> <span class="o">=</span> <span class="n">coord</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<a name="line-358"></a>
<a name="line-359"></a>  <span class="c1">// Make room for element centroid coordinates</span>
<a name="line-360"></a>  <span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="o">&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span> <span class="n">tk</span><span class="o">::</span><span class="n">real</span> <span class="o">&gt;</span><span class="p">,</span> <span class="mi">3</span> <span class="o">&gt;</span> <span class="n">cent</span><span class="p">;</span>
<a name="line-361"></a>  <span class="k">auto</span><span class="o">&amp;</span> <span class="n">cx</span> <span class="o">=</span> <span class="n">cent</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<a name="line-362"></a>  <span class="k">auto</span><span class="o">&amp;</span> <span class="n">cy</span> <span class="o">=</span> <span class="n">cent</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<a name="line-363"></a>  <span class="k">auto</span><span class="o">&amp;</span> <span class="n">cz</span> <span class="o">=</span> <span class="n">cent</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<a name="line-364"></a>  <span class="k">auto</span> <span class="n">num</span> <span class="o">=</span> <span class="n">inpoel</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="o">/</span><span class="mi">4</span><span class="p">;</span>
<a name="line-365"></a>  <span class="n">cx</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span> <span class="n">num</span> <span class="p">);</span>
<a name="line-366"></a>  <span class="n">cy</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span> <span class="n">num</span> <span class="p">);</span>
<a name="line-367"></a>  <span class="n">cz</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span> <span class="n">num</span> <span class="p">);</span>
<a name="line-368"></a>
<a name="line-369"></a>  <span class="c1">// Compute element centroids for mesh passed in</span>
<a name="line-370"></a>  <span class="k">for</span> <span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="n">e</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">e</span><span class="o">&lt;</span><span class="n">num</span><span class="p">;</span> <span class="o">++</span><span class="n">e</span><span class="p">)</span> <span class="p">{</span>
<a name="line-371"></a>    <span class="k">auto</span> <span class="n">A</span> <span class="o">=</span> <span class="n">inpoel</span><span class="p">[</span><span class="n">e</span><span class="o">*</span><span class="mi">4</span><span class="o">+</span><span class="mi">0</span><span class="p">];</span>
<a name="line-372"></a>    <span class="k">auto</span> <span class="n">B</span> <span class="o">=</span> <span class="n">inpoel</span><span class="p">[</span><span class="n">e</span><span class="o">*</span><span class="mi">4</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
<a name="line-373"></a>    <span class="k">auto</span> <span class="n">C</span> <span class="o">=</span> <span class="n">inpoel</span><span class="p">[</span><span class="n">e</span><span class="o">*</span><span class="mi">4</span><span class="o">+</span><span class="mi">2</span><span class="p">];</span>
<a name="line-374"></a>    <span class="k">auto</span> <span class="n">D</span> <span class="o">=</span> <span class="n">inpoel</span><span class="p">[</span><span class="n">e</span><span class="o">*</span><span class="mi">4</span><span class="o">+</span><span class="mi">3</span><span class="p">];</span>
<a name="line-375"></a>    <span class="n">cx</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">A</span><span class="p">]</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="n">B</span><span class="p">]</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="n">C</span><span class="p">]</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="n">D</span><span class="p">])</span> <span class="o">/</span> <span class="mf">4.0</span><span class="p">;</span>
<a name="line-376"></a>    <span class="n">cy</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">A</span><span class="p">]</span> <span class="o">+</span> <span class="n">y</span><span class="p">[</span><span class="n">B</span><span class="p">]</span> <span class="o">+</span> <span class="n">y</span><span class="p">[</span><span class="n">C</span><span class="p">]</span> <span class="o">+</span> <span class="n">y</span><span class="p">[</span><span class="n">D</span><span class="p">])</span> <span class="o">/</span> <span class="mf">4.0</span><span class="p">;</span>
<a name="line-377"></a>    <span class="n">cz</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="n">A</span><span class="p">]</span> <span class="o">+</span> <span class="n">z</span><span class="p">[</span><span class="n">B</span><span class="p">]</span> <span class="o">+</span> <span class="n">z</span><span class="p">[</span><span class="n">C</span><span class="p">]</span> <span class="o">+</span> <span class="n">z</span><span class="p">[</span><span class="n">D</span><span class="p">])</span> <span class="o">/</span> <span class="mf">4.0</span><span class="p">;</span>
<a name="line-378"></a>  <span class="p">}</span>
<a name="line-379"></a>
<a name="line-380"></a>  <span class="k">return</span> <span class="n">cent</span><span class="p">;</span>
<a name="line-381"></a><span class="p">}</span>
<a name="line-382"></a>
<a name="line-383"></a><span class="n">std</span><span class="o">::</span><span class="n">unordered_map</span><span class="o">&lt;</span> <span class="kt">int</span><span class="p">,</span> <span class="n">Partitioner</span><span class="o">::</span><span class="n">MeshData</span> <span class="o">&gt;</span>
<a name="line-384"></a><span class="n">Partitioner</span><span class="o">::</span><span class="n">categorize</span><span class="p">(</span> <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span> <span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="o">&gt;&amp;</span> <span class="n">target</span> <span class="p">)</span> <span class="k">const</span>
<a name="line-385"></a><span class="c1">// *****************************************************************************</span>
<a name="line-386"></a><span class="c1">// Categorize mesh data by target</span>
<a name="line-387"></a><span class="c1">//! \param[in] target Target chares of mesh elements, size: number of</span>
<a name="line-388"></a><span class="c1">//!   elements in the chunk of the mesh graph on this compute node.</span>
<a name="line-389"></a><span class="c1">//! \return Vector of global mesh node ids connecting elements owned by each</span>
<a name="line-390"></a><span class="c1">//!   target chare.</span>
<a name="line-391"></a><span class="c1">// *****************************************************************************</span>
<a name="line-392"></a><span class="p">{</span>
<a name="line-393"></a>  <span class="n">Assert</span><span class="p">(</span> <span class="n">target</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">==</span> <span class="n">m_ginpoel</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="o">/</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;Size mismatch&quot;</span><span class="p">);</span>
<a name="line-394"></a>
<a name="line-395"></a>  <span class="k">using</span> <span class="n">Face</span> <span class="o">=</span> <span class="n">tk</span><span class="o">::</span><span class="n">UnsMesh</span><span class="o">::</span><span class="n">Face</span><span class="p">;</span>
<a name="line-396"></a>
<a name="line-397"></a>  <span class="c1">// Build hash map associating side set id to boundary faces</span>
<a name="line-398"></a>  <span class="n">std</span><span class="o">::</span><span class="n">unordered_map</span><span class="o">&lt;</span> <span class="n">Face</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span>
<a name="line-399"></a>                      <span class="n">tk</span><span class="o">::</span><span class="n">UnsMesh</span><span class="o">::</span><span class="n">Hash</span><span class="o">&lt;</span><span class="mi">3</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">tk</span><span class="o">::</span><span class="n">UnsMesh</span><span class="o">::</span><span class="n">Eq</span><span class="o">&lt;</span><span class="mi">3</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="n">faceside</span><span class="p">;</span>
<a name="line-400"></a>  <span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="p">[</span> <span class="n">setid</span><span class="p">,</span> <span class="n">faceids</span> <span class="p">]</span> <span class="o">:</span> <span class="n">m_bface</span><span class="p">)</span>
<a name="line-401"></a>    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="nl">f</span> <span class="p">:</span> <span class="n">faceids</span><span class="p">)</span>
<a name="line-402"></a>      <span class="n">faceside</span><span class="p">[</span> <span class="p">{{</span> <span class="n">m_triinpoel</span><span class="p">[</span><span class="n">f</span><span class="o">*</span><span class="mi">3</span><span class="o">+</span><span class="mi">0</span><span class="p">],</span>
<a name="line-403"></a>                   <span class="n">m_triinpoel</span><span class="p">[</span><span class="n">f</span><span class="o">*</span><span class="mi">3</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span>
<a name="line-404"></a>                   <span class="n">m_triinpoel</span><span class="p">[</span><span class="n">f</span><span class="o">*</span><span class="mi">3</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="p">}}</span> <span class="p">]</span> <span class="o">=</span> <span class="n">setid</span><span class="p">;</span>
<a name="line-405"></a>
<a name="line-406"></a>  <span class="c1">// Build hash map associating side set ids to boundary nodes</span>
<a name="line-407"></a>  <span class="n">std</span><span class="o">::</span><span class="n">unordered_map</span><span class="o">&lt;</span> <span class="n">std</span><span class="o">::</span><span class="kt">size_t</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">unordered_set</span><span class="o">&lt;</span> <span class="kt">int</span> <span class="o">&gt;</span> <span class="o">&gt;</span> <span class="n">nodeside</span><span class="p">;</span>
<a name="line-408"></a>  <span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="p">[</span> <span class="n">setid</span><span class="p">,</span> <span class="n">nodes</span> <span class="p">]</span> <span class="o">:</span> <span class="n">m_bnode</span><span class="p">)</span>
<a name="line-409"></a>    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="nl">n</span> <span class="p">:</span> <span class="n">nodes</span><span class="p">)</span>
<a name="line-410"></a>      <span class="n">nodeside</span><span class="p">[</span> <span class="n">n</span> <span class="p">].</span><span class="n">insert</span><span class="p">(</span> <span class="n">setid</span> <span class="p">);</span>
<a name="line-411"></a>
<a name="line-412"></a>  <span class="c1">// Categorize mesh data (tets, node coordinates, and boundary data) by target</span>
<a name="line-413"></a>  <span class="c1">// chare based on which chare the partitioner assigned elements (tets) to</span>
<a name="line-414"></a>  <span class="n">std</span><span class="o">::</span><span class="n">unordered_map</span><span class="o">&lt;</span> <span class="kt">int</span><span class="p">,</span> <span class="n">MeshData</span> <span class="o">&gt;</span> <span class="n">chmesh</span><span class="p">;</span>
<a name="line-415"></a>  <span class="k">for</span> <span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="n">e</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">e</span><span class="o">&lt;</span><span class="n">target</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">e</span><span class="p">)</span> <span class="p">{</span>
<a name="line-416"></a>    <span class="c1">// Construct a tetrahedron with global node ids</span>
<a name="line-417"></a>    <span class="n">tk</span><span class="o">::</span><span class="n">UnsMesh</span><span class="o">::</span><span class="n">Tet</span> <span class="n">t</span><span class="p">{{</span> <span class="n">m_ginpoel</span><span class="p">[</span><span class="n">e</span><span class="o">*</span><span class="mi">4</span><span class="o">+</span><span class="mi">0</span><span class="p">],</span> <span class="n">m_ginpoel</span><span class="p">[</span><span class="n">e</span><span class="o">*</span><span class="mi">4</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span>
<a name="line-418"></a>                         <span class="n">m_ginpoel</span><span class="p">[</span><span class="n">e</span><span class="o">*</span><span class="mi">4</span><span class="o">+</span><span class="mi">2</span><span class="p">],</span> <span class="n">m_ginpoel</span><span class="p">[</span><span class="n">e</span><span class="o">*</span><span class="mi">4</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span> <span class="p">}};</span>
<a name="line-419"></a>    <span class="c1">// Categorize tetrahedron (domain element) connectivity</span>
<a name="line-420"></a>    <span class="k">auto</span><span class="o">&amp;</span> <span class="n">mesh</span> <span class="o">=</span> <span class="n">chmesh</span><span class="p">[</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">target</span><span class="p">[</span><span class="n">e</span><span class="p">])</span> <span class="p">];</span>
<a name="line-421"></a>    <span class="k">auto</span><span class="o">&amp;</span> <span class="n">inpoel</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">get</span><span class="o">&lt;</span> <span class="mi">0</span> <span class="o">&gt;</span><span class="p">(</span> <span class="n">mesh</span> <span class="p">);</span>
<a name="line-422"></a>    <span class="n">inpoel</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span> <span class="n">end</span><span class="p">(</span><span class="n">inpoel</span><span class="p">),</span> <span class="n">begin</span><span class="p">(</span><span class="n">t</span><span class="p">),</span> <span class="n">end</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="p">);</span>
<a name="line-423"></a>    <span class="c1">// Categorize mesh block ids and associated local tet ids (local tet ids</span>
<a name="line-424"></a>    <span class="c1">// basically correspond to the inpoel entries updated in line above).</span>
<a name="line-425"></a><span class="hll">    <span class="p">[[</span><span class="n">maybe_unused</span><span class="p">]]</span> <span class="kt">bool</span> <span class="n">added</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span><div class="verbose expandable"><span class="error2">&lt;--- The scope of the variable 'added' can be reduced. <span class="marker">[+]</span></span><div class="content">The scope of the variable &apos;added&apos; can be reduced. Warning: Be careful when fixing this message, especially when there are inner loops. Here is an example where cppcheck will write that the scope for &apos;i&apos; can be reduced:
void f(int x)
{
    int i = 0;
    if (x) {
        // it&apos;s safe to move &apos;int i = 0;&apos; here
        for (int n = 0; n &lt; 10; ++n) {
            // it is possible but not safe to move &apos;int i = 0;&apos; here
            do_something(&amp;i);
        }
    }
}
When you see this message it is always safe to reduce the variable scope 1 level.</div></div>
</span><a name="line-426"></a>    <span class="k">auto</span><span class="o">&amp;</span> <span class="n">elblock</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">get</span><span class="o">&lt;</span> <span class="mi">3</span> <span class="o">&gt;</span><span class="p">(</span> <span class="n">mesh</span> <span class="p">);</span>
<a name="line-427"></a>    <span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="p">[</span><span class="n">blid</span><span class="p">,</span> <span class="n">elset</span><span class="p">]</span> <span class="o">:</span> <span class="n">m_elemBlockId</span><span class="p">)</span> <span class="p">{</span>
<a name="line-428"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">elset</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="o">!=</span> <span class="n">elset</span><span class="p">.</span><span class="n">end</span><span class="p">())</span> <span class="p">{</span>
<a name="line-429"></a>        <span class="n">elblock</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">blid</span><span class="p">);</span>
<a name="line-430"></a>        <span class="n">added</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<a name="line-431"></a>      <span class="p">}</span>
<a name="line-432"></a>    <span class="p">}</span>
<a name="line-433"></a>    <span class="n">Assert</span><span class="p">(</span><span class="n">added</span><span class="p">,</span> <span class="s">&quot;Tet element not found in any block after partitioning&quot;</span><span class="p">);</span>
<a name="line-434"></a>    <span class="c1">// Categorize boundary face connectivity</span>
<a name="line-435"></a>    <span class="k">auto</span><span class="o">&amp;</span> <span class="n">bconn</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">get</span><span class="o">&lt;</span> <span class="mi">1</span> <span class="o">&gt;</span><span class="p">(</span> <span class="n">mesh</span> <span class="p">);</span>
<a name="line-436"></a>    <span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="o">&lt;</span><span class="n">Face</span><span class="p">,</span><span class="mi">4</span><span class="o">&gt;</span> <span class="n">face</span><span class="p">{{</span> <span class="p">{{</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">t</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]}},</span> <span class="p">{{</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">t</span><span class="p">[</span><span class="mi">3</span><span class="p">]}},</span>
<a name="line-437"></a>                              <span class="p">{{</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">t</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">t</span><span class="p">[</span><span class="mi">2</span><span class="p">]}},</span> <span class="p">{{</span><span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">t</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">t</span><span class="p">[</span><span class="mi">3</span><span class="p">]}}</span> <span class="p">}};</span>
<a name="line-438"></a>    <span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="nl">f</span> <span class="p">:</span> <span class="n">face</span><span class="p">)</span> <span class="p">{</span>
<a name="line-439"></a>      <span class="k">auto</span> <span class="n">it</span> <span class="o">=</span> <span class="n">faceside</span><span class="p">.</span><span class="n">find</span><span class="p">(</span> <span class="n">f</span> <span class="p">);</span>
<a name="line-440"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">it</span> <span class="o">!=</span> <span class="n">end</span><span class="p">(</span><span class="n">faceside</span><span class="p">))</span> <span class="p">{</span>
<a name="line-441"></a>        <span class="k">auto</span><span class="o">&amp;</span> <span class="n">s</span> <span class="o">=</span> <span class="n">bconn</span><span class="p">[</span> <span class="n">it</span><span class="o">-&gt;</span><span class="n">second</span> <span class="p">];</span>
<a name="line-442"></a>        <span class="n">s</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span> <span class="n">end</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="n">begin</span><span class="p">(</span><span class="n">f</span><span class="p">),</span> <span class="n">end</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="p">);</span>
<a name="line-443"></a>      <span class="p">}</span>
<a name="line-444"></a>    <span class="p">}</span>
<a name="line-445"></a>    <span class="c1">// Categorize boundary node lists</span>
<a name="line-446"></a>    <span class="k">auto</span><span class="o">&amp;</span> <span class="n">bnode</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">get</span><span class="o">&lt;</span> <span class="mi">2</span> <span class="o">&gt;</span><span class="p">(</span> <span class="n">mesh</span> <span class="p">);</span>
<a name="line-447"></a>    <span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="nl">n</span> <span class="p">:</span> <span class="n">t</span><span class="p">)</span> <span class="p">{</span>
<a name="line-448"></a>      <span class="k">auto</span> <span class="n">it</span> <span class="o">=</span> <span class="n">nodeside</span><span class="p">.</span><span class="n">find</span><span class="p">(</span> <span class="n">n</span> <span class="p">);</span>
<a name="line-449"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">it</span> <span class="o">!=</span> <span class="n">end</span><span class="p">(</span><span class="n">nodeside</span><span class="p">))</span>
<a name="line-450"></a>        <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="nl">s</span> <span class="p">:</span> <span class="n">it</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">)</span>
<a name="line-451"></a>          <span class="n">bnode</span><span class="p">[</span> <span class="n">s</span> <span class="p">].</span><span class="n">push_back</span><span class="p">(</span> <span class="n">n</span> <span class="p">);</span>
<a name="line-452"></a>    <span class="p">}</span>
<a name="line-453"></a>  <span class="p">}</span>
<a name="line-454"></a>
<a name="line-455"></a>  <span class="c1">// Make boundary node lists unique per side set</span>
<a name="line-456"></a>  <span class="k">for</span> <span class="p">(</span><span class="k">auto</span><span class="o">&amp;</span> <span class="nl">c</span> <span class="p">:</span> <span class="n">chmesh</span><span class="p">)</span>
<a name="line-457"></a>    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span><span class="o">&amp;</span> <span class="nl">n</span> <span class="p">:</span> <span class="n">std</span><span class="o">::</span><span class="n">get</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span><span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">second</span><span class="p">))</span>
<a name="line-458"></a>       <span class="n">tk</span><span class="o">::</span><span class="n">unique</span><span class="p">(</span> <span class="n">n</span><span class="p">.</span><span class="n">second</span> <span class="p">);</span>
<a name="line-459"></a>
<a name="line-460"></a>  <span class="c1">// Make sure all compute nodes have target chares assigned</span>
<a name="line-461"></a>  <span class="n">Assert</span><span class="p">(</span> <span class="o">!</span><span class="n">chmesh</span><span class="p">.</span><span class="n">empty</span><span class="p">(),</span> <span class="s">&quot;No elements have been assigned to a chare&quot;</span> <span class="p">);</span>
<a name="line-462"></a>
<a name="line-463"></a>  <span class="c1">// This check should always be done, hence ErrChk and not Assert, as it</span>
<a name="line-464"></a>  <span class="c1">// can result from particular pathological combinations of (1) too large</span>
<a name="line-465"></a>  <span class="c1">// degree of virtualization, (2) too many compute nodes, and/or (3) too small</span>
<a name="line-466"></a>  <span class="c1">// of a mesh and not due to programmer error.</span>
<a name="line-467"></a>  <span class="k">for</span><span class="p">(</span><span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="nl">c</span> <span class="p">:</span> <span class="n">chmesh</span><span class="p">)</span>
<a name="line-468"></a>    <span class="n">ErrChk</span><span class="p">(</span> <span class="o">!</span><span class="n">std</span><span class="o">::</span><span class="n">get</span><span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">second</span><span class="p">).</span><span class="n">empty</span><span class="p">(),</span>
<a name="line-469"></a>            <span class="s">&quot;Overdecomposition of the mesh is too large compared to the &quot;</span>
<a name="line-470"></a>            <span class="s">&quot;number of work units computed based on the degree of &quot;</span>
<a name="line-471"></a>            <span class="s">&quot;virtualization desired. As a result, there would be at least &quot;</span>
<a name="line-472"></a>            <span class="s">&quot;one work unit with no mesh elements to work on, i.e., nothing &quot;</span>
<a name="line-473"></a>            <span class="s">&quot;to do. Solution 1: decrease the virtualization to a lower &quot;</span>
<a name="line-474"></a>            <span class="s">&quot;value using the command-line argument &#39;-u&#39;. Solution 2: &quot;</span>
<a name="line-475"></a>            <span class="s">&quot;decrease the number processing elements (PEs and/or compute &quot;</span>
<a name="line-476"></a>            <span class="s">&quot;nodes) using the charmrun command-line argument &#39;+pN&#39; where N is &quot;</span>
<a name="line-477"></a>            <span class="s">&quot;the number of PEs (or in SMP-mode in combination with +ppn to &quot;</span>
<a name="line-478"></a>            <span class="s">&quot;reduce the number of compute nodes), which implicitly increases &quot;</span>
<a name="line-479"></a>            <span class="s">&quot;the size (and thus decreases the number) of work units.)&quot;</span> <span class="p">);</span>
<a name="line-480"></a>
<a name="line-481"></a>  <span class="k">return</span> <span class="n">chmesh</span><span class="p">;</span>
<a name="line-482"></a><span class="p">}</span>
<a name="line-483"></a>
<a name="line-484"></a><span class="n">tk</span><span class="o">::</span><span class="n">UnsMesh</span><span class="o">::</span><span class="n">CoordMap</span>
<a name="line-485"></a><span class="n">Partitioner</span><span class="o">::</span><span class="n">coordmap</span><span class="p">(</span> <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span> <span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="o">&gt;&amp;</span> <span class="n">inpoel</span> <span class="p">)</span>
<a name="line-486"></a><span class="c1">// *****************************************************************************</span>
<a name="line-487"></a><span class="c1">// Extract coordinates associated to global nodes of a mesh chunk</span>
<a name="line-488"></a><span class="c1">//! \param[in] inpoel Mesh connectivity</span>
<a name="line-489"></a><span class="c1">//! \return Map storing the coordinates of unique nodes associated to global</span>
<a name="line-490"></a><span class="c1">//!    node IDs in mesh given by inpoel</span>
<a name="line-491"></a><span class="c1">// *****************************************************************************</span>
<a name="line-492"></a><span class="p">{</span>
<a name="line-493"></a>  <span class="n">Assert</span><span class="p">(</span> <span class="n">inpoel</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;Incomplete mesh connectivity&quot;</span> <span class="p">);</span>
<a name="line-494"></a>
<a name="line-495"></a>  <span class="n">tk</span><span class="o">::</span><span class="n">UnsMesh</span><span class="o">::</span><span class="n">CoordMap</span> <span class="n">map</span><span class="p">;</span>
<a name="line-496"></a>
<a name="line-497"></a>  <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="nl">g</span> <span class="p">:</span> <span class="n">tk</span><span class="o">::</span><span class="n">uniquecopy</span><span class="p">(</span><span class="n">inpoel</span><span class="p">))</span> <span class="p">{</span>
<a name="line-498"></a>     <span class="k">auto</span> <span class="n">i</span> <span class="o">=</span> <span class="n">tk</span><span class="o">::</span><span class="n">cref_find</span><span class="p">(</span> <span class="n">m_lid</span><span class="p">,</span> <span class="n">g</span> <span class="p">);</span>
<a name="line-499"></a>     <span class="k">auto</span><span class="o">&amp;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">map</span><span class="p">[</span><span class="n">g</span><span class="p">];</span>
<a name="line-500"></a>     <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">m_coord</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">];</span>
<a name="line-501"></a>     <span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">m_coord</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">];</span>
<a name="line-502"></a>     <span class="n">c</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">m_coord</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">i</span><span class="p">];</span>
<a name="line-503"></a>  <span class="p">}</span>
<a name="line-504"></a>
<a name="line-505"></a>  <span class="n">Assert</span><span class="p">(</span> <span class="n">tk</span><span class="o">::</span><span class="n">uniquecopy</span><span class="p">(</span><span class="n">inpoel</span><span class="p">).</span><span class="n">size</span><span class="p">()</span> <span class="o">==</span> <span class="n">map</span><span class="p">.</span><span class="n">size</span><span class="p">(),</span> <span class="s">&quot;Size mismatch&quot;</span> <span class="p">);</span>
<a name="line-506"></a>
<a name="line-507"></a>  <span class="k">return</span> <span class="n">map</span><span class="p">;</span>
<a name="line-508"></a><span class="p">}</span>
<a name="line-509"></a>
<a name="line-510"></a><span class="kt">void</span>
<a name="line-511"></a><span class="n">Partitioner</span><span class="o">::</span><span class="n">distribute</span><span class="p">(</span> <span class="n">std</span><span class="o">::</span><span class="n">unordered_map</span><span class="o">&lt;</span> <span class="kt">int</span><span class="p">,</span> <span class="n">MeshData</span> <span class="o">&gt;&amp;&amp;</span> <span class="n">mesh</span> <span class="p">)</span>
<a name="line-512"></a><span class="c1">// *****************************************************************************</span>
<a name="line-513"></a><span class="c1">// Distribute mesh to target compute nodes after mesh partitioning</span>
<a name="line-514"></a><span class="c1">//! \param[in] mesh Mesh data categorized by target by target chares</span>
<a name="line-515"></a><span class="c1">// *****************************************************************************</span>
<a name="line-516"></a><span class="p">{</span>
<a name="line-517"></a>  <span class="k">auto</span> <span class="n">dist</span> <span class="o">=</span> <span class="n">distribution</span><span class="p">(</span> <span class="n">m_nchare</span> <span class="p">);</span>
<a name="line-518"></a>
<a name="line-519"></a>  <span class="c1">// Extract mesh data whose chares are on (&quot;owned by&quot;) this compute node</span>
<a name="line-520"></a>  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">c</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">c</span><span class="o">&lt;</span><span class="n">dist</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span> <span class="o">++</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
<a name="line-521"></a>    <span class="k">auto</span> <span class="n">chid</span> <span class="o">=</span> <span class="n">CkMyNode</span><span class="p">()</span> <span class="o">*</span> <span class="n">dist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">c</span><span class="p">;</span> <span class="c1">// compute owned chare ID</span>
<a name="line-522"></a>    <span class="k">const</span> <span class="k">auto</span> <span class="n">it</span> <span class="o">=</span> <span class="n">mesh</span><span class="p">.</span><span class="n">find</span><span class="p">(</span> <span class="n">chid</span> <span class="p">);</span>    <span class="c1">// attempt to find its mesh data</span>
<a name="line-523"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">it</span> <span class="o">!=</span> <span class="n">end</span><span class="p">(</span><span class="n">mesh</span><span class="p">))</span> <span class="p">{</span>                <span class="c1">// if found</span>
<a name="line-524"></a>      <span class="c1">// Store own tetrahedron connectivity</span>
<a name="line-525"></a>      <span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="n">inpoel</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">get</span><span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">(</span> <span class="n">it</span><span class="o">-&gt;</span><span class="n">second</span> <span class="p">);</span>
<a name="line-526"></a>      <span class="k">auto</span><span class="o">&amp;</span> <span class="n">inp</span> <span class="o">=</span> <span class="n">m_chinpoel</span><span class="p">[</span> <span class="n">chid</span> <span class="p">];</span>     <span class="c1">// will store own mesh connectivity</span>
<a name="line-527"></a>      <span class="n">inp</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span> <span class="n">end</span><span class="p">(</span><span class="n">inp</span><span class="p">),</span> <span class="n">begin</span><span class="p">(</span><span class="n">inpoel</span><span class="p">),</span> <span class="n">end</span><span class="p">(</span><span class="n">inpoel</span><span class="p">)</span> <span class="p">);</span>
<a name="line-528"></a>      <span class="c1">// Store own mesh block id and associated tet ids</span>
<a name="line-529"></a>      <span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="n">elblock</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">get</span><span class="o">&lt;</span><span class="mi">3</span><span class="o">&gt;</span><span class="p">(</span> <span class="n">it</span><span class="o">-&gt;</span><span class="n">second</span> <span class="p">);</span>
<a name="line-530"></a>      <span class="k">auto</span><span class="o">&amp;</span> <span class="n">cheb</span> <span class="o">=</span> <span class="n">m_chelemblockid</span><span class="p">[</span> <span class="n">chid</span> <span class="p">];</span>
<a name="line-531"></a>      <span class="n">cheb</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span> <span class="n">end</span><span class="p">(</span><span class="n">cheb</span><span class="p">),</span> <span class="n">begin</span><span class="p">(</span><span class="n">elblock</span><span class="p">),</span> <span class="n">end</span><span class="p">(</span><span class="n">elblock</span><span class="p">)</span> <span class="p">);</span>
<a name="line-532"></a>      <span class="c1">// Store own node coordinates</span>
<a name="line-533"></a>      <span class="k">auto</span><span class="o">&amp;</span> <span class="n">chcm</span> <span class="o">=</span> <span class="n">m_chcoordmap</span><span class="p">[</span> <span class="n">chid</span> <span class="p">];</span>  <span class="c1">// will store own node coordinates</span>
<a name="line-534"></a>      <span class="k">auto</span> <span class="n">cm</span> <span class="o">=</span> <span class="n">coordmap</span><span class="p">(</span> <span class="n">inpoel</span> <span class="p">);</span>       <span class="c1">// extract node coordinates </span>
<a name="line-535"></a>      <span class="n">chcm</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span> <span class="n">begin</span><span class="p">(</span><span class="n">cm</span><span class="p">),</span> <span class="n">end</span><span class="p">(</span><span class="n">cm</span><span class="p">)</span> <span class="p">);</span>  <span class="c1">// concatenate node coords</span>
<a name="line-536"></a>      <span class="c1">// Store own boundary face connectivity</span>
<a name="line-537"></a>      <span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="n">bconn</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">get</span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">(</span> <span class="n">it</span><span class="o">-&gt;</span><span class="n">second</span> <span class="p">);</span>
<a name="line-538"></a>      <span class="k">auto</span><span class="o">&amp;</span> <span class="n">bface</span> <span class="o">=</span> <span class="n">m_chbface</span><span class="p">[</span> <span class="n">chid</span> <span class="p">];</span>    <span class="c1">// will store own boundary faces</span>
<a name="line-539"></a>      <span class="k">auto</span><span class="o">&amp;</span> <span class="n">t</span> <span class="o">=</span> <span class="n">m_chtriinpoel</span><span class="p">[</span> <span class="n">chid</span> <span class="p">];</span>    <span class="c1">// wil store own boundary face conn</span>
<a name="line-540"></a>      <span class="k">auto</span><span class="o">&amp;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">m_nface</span><span class="p">[</span> <span class="n">chid</span> <span class="p">];</span>          <span class="c1">// use counter for chare</span>
<a name="line-541"></a>      <span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="p">[</span> <span class="n">setid</span><span class="p">,</span> <span class="n">faceids</span> <span class="p">]</span> <span class="o">:</span> <span class="n">bconn</span><span class="p">)</span> <span class="p">{</span>
<a name="line-542"></a>        <span class="k">auto</span><span class="o">&amp;</span> <span class="n">b</span> <span class="o">=</span> <span class="n">bface</span><span class="p">[</span> <span class="n">setid</span> <span class="p">];</span>
<a name="line-543"></a>        <span class="k">for</span> <span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">faceids</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="o">/</span><span class="mi">3</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
<a name="line-544"></a>          <span class="n">b</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span> <span class="n">f</span><span class="o">++</span> <span class="p">);</span>
<a name="line-545"></a>          <span class="n">t</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span> <span class="n">faceids</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="mi">3</span><span class="o">+</span><span class="mi">0</span><span class="p">]</span> <span class="p">);</span>
<a name="line-546"></a>          <span class="n">t</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span> <span class="n">faceids</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="mi">3</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="p">);</span>
<a name="line-547"></a>          <span class="n">t</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span> <span class="n">faceids</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="mi">3</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="p">);</span>
<a name="line-548"></a>        <span class="p">}</span>
<a name="line-549"></a>      <span class="p">}</span>
<a name="line-550"></a>      <span class="c1">// Store own boundary node lists</span>
<a name="line-551"></a>      <span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="n">bnode</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">get</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span><span class="p">(</span> <span class="n">it</span><span class="o">-&gt;</span><span class="n">second</span> <span class="p">);</span>
<a name="line-552"></a>      <span class="k">auto</span><span class="o">&amp;</span> <span class="n">nodes</span> <span class="o">=</span> <span class="n">m_chbnode</span><span class="p">[</span> <span class="n">chid</span> <span class="p">];</span>    <span class="c1">// will store own boundary nodes</span>
<a name="line-553"></a>      <span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="p">[</span> <span class="n">setid</span><span class="p">,</span> <span class="n">nodeids</span> <span class="p">]</span> <span class="o">:</span> <span class="n">bnode</span><span class="p">)</span> <span class="p">{</span>
<a name="line-554"></a>        <span class="k">auto</span><span class="o">&amp;</span> <span class="n">b</span> <span class="o">=</span> <span class="n">nodes</span><span class="p">[</span> <span class="n">setid</span> <span class="p">];</span>
<a name="line-555"></a>        <span class="n">b</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span> <span class="n">end</span><span class="p">(</span><span class="n">b</span><span class="p">),</span> <span class="n">begin</span><span class="p">(</span><span class="n">nodeids</span><span class="p">),</span> <span class="n">end</span><span class="p">(</span><span class="n">nodeids</span><span class="p">)</span> <span class="p">);</span>
<a name="line-556"></a>      <span class="p">}</span>
<a name="line-557"></a>      <span class="c1">// Remove chare ID and mesh data</span>
<a name="line-558"></a>      <span class="n">mesh</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span> <span class="n">it</span> <span class="p">);</span>
<a name="line-559"></a>    <span class="p">}</span>
<a name="line-560"></a>    <span class="n">Assert</span><span class="p">(</span> <span class="n">mesh</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">chid</span><span class="p">)</span> <span class="o">==</span> <span class="n">end</span><span class="p">(</span><span class="n">mesh</span><span class="p">),</span> <span class="s">&quot;Not all owned mesh data stored&quot;</span> <span class="p">);</span>
<a name="line-561"></a>  <span class="p">}</span>
<a name="line-562"></a>
<a name="line-563"></a>  <span class="c1">// Construct export map (associating mesh connectivities with global node</span>
<a name="line-564"></a>  <span class="c1">// indices and node coordinates) for mesh chunks associated to chare IDs</span>
<a name="line-565"></a>  <span class="c1">// owned by chares we do not own.</span>
<a name="line-566"></a>  <span class="n">std</span><span class="o">::</span><span class="n">unordered_map</span><span class="o">&lt;</span> <span class="kt">int</span><span class="p">,</span>                     <span class="c1">// target compute node</span>
<a name="line-567"></a>    <span class="n">std</span><span class="o">::</span><span class="n">unordered_map</span><span class="o">&lt;</span> <span class="kt">int</span><span class="p">,</span>                   <span class="c1">// chare ID</span>
<a name="line-568"></a>      <span class="n">std</span><span class="o">::</span><span class="n">tuple</span><span class="o">&lt;</span>
<a name="line-569"></a>        <span class="c1">// (domain-element) tetrahedron connectivity</span>
<a name="line-570"></a>        <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span> <span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="o">&gt;</span><span class="p">,</span>
<a name="line-571"></a>        <span class="c1">// (domain) node IDs &amp; coordinates</span>
<a name="line-572"></a>        <span class="n">tk</span><span class="o">::</span><span class="n">UnsMesh</span><span class="o">::</span><span class="n">CoordMap</span><span class="p">,</span>
<a name="line-573"></a>        <span class="c1">// boundary side set + face connectivity</span>
<a name="line-574"></a>        <span class="n">std</span><span class="o">::</span><span class="n">unordered_map</span><span class="o">&lt;</span> <span class="kt">int</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span> <span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="o">&gt;</span> <span class="o">&gt;</span><span class="p">,</span>
<a name="line-575"></a>        <span class="c1">// boundary side set + node list</span>
<a name="line-576"></a>        <span class="n">std</span><span class="o">::</span><span class="n">unordered_map</span><span class="o">&lt;</span> <span class="kt">int</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span> <span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="o">&gt;</span> <span class="o">&gt;</span><span class="p">,</span>
<a name="line-577"></a>        <span class="c1">// Mesh block ids + local tet ids</span>
<a name="line-578"></a>        <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span> <span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="o">&gt;</span>
<a name="line-579"></a>      <span class="o">&gt;</span> <span class="o">&gt;</span> <span class="o">&gt;</span> <span class="n">exp</span><span class="p">;</span>
<a name="line-580"></a>
<a name="line-581"></a>  <span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="nl">c</span> <span class="p">:</span> <span class="n">mesh</span><span class="p">)</span>
<a name="line-582"></a>    <span class="n">exp</span><span class="p">[</span> <span class="n">node</span><span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">first</span><span class="p">)</span> <span class="p">][</span> <span class="n">c</span><span class="p">.</span><span class="n">first</span> <span class="p">]</span> <span class="o">=</span>
<a name="line-583"></a>      <span class="n">std</span><span class="o">::</span><span class="n">make_tuple</span><span class="p">(</span> <span class="n">std</span><span class="o">::</span><span class="n">get</span><span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">second</span><span class="p">),</span>
<a name="line-584"></a>                       <span class="n">coordmap</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">get</span><span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">second</span><span class="p">)),</span>
<a name="line-585"></a>                       <span class="n">std</span><span class="o">::</span><span class="n">get</span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">second</span><span class="p">),</span>
<a name="line-586"></a>                       <span class="n">std</span><span class="o">::</span><span class="n">get</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span><span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">second</span><span class="p">),</span>
<a name="line-587"></a>                       <span class="n">std</span><span class="o">::</span><span class="n">get</span><span class="o">&lt;</span><span class="mi">3</span><span class="o">&gt;</span><span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">second</span><span class="p">)</span> <span class="p">);</span>
<a name="line-588"></a>
<a name="line-589"></a>  <span class="c1">// Export chare IDs and mesh we do not own to fellow compute nodes</span>
<a name="line-590"></a>  <span class="k">if</span> <span class="p">(</span><span class="n">exp</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
<a name="line-591"></a>    <span class="k">if</span> <span class="p">(</span> <span class="n">g_inputdeck</span><span class="p">.</span><span class="n">get</span><span class="o">&lt;</span> <span class="n">tag</span><span class="o">::</span><span class="n">cmd</span><span class="p">,</span> <span class="n">tag</span><span class="o">::</span><span class="n">feedback</span> <span class="o">&gt;</span><span class="p">()</span> <span class="p">)</span> <span class="n">m_host</span><span class="p">.</span><span class="n">pedistributed</span><span class="p">();</span>
<a name="line-592"></a>    <span class="n">contribute</span><span class="p">(</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="kt">size_t</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">m_meshid</span><span class="p">,</span> <span class="n">CkReduction</span><span class="o">::</span><span class="n">nop</span><span class="p">,</span>
<a name="line-593"></a>                <span class="n">m_cbp</span><span class="p">.</span><span class="n">get</span><span class="o">&lt;</span> <span class="n">tag</span><span class="o">::</span><span class="n">distributed</span> <span class="o">&gt;</span><span class="p">()</span> <span class="p">);</span>
<a name="line-594"></a>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="line-595"></a>     <span class="n">m_ndist</span> <span class="o">+=</span> <span class="n">exp</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
<a name="line-596"></a>     <span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="p">[</span> <span class="n">targetnode</span><span class="p">,</span> <span class="n">chunk</span> <span class="p">]</span> <span class="o">:</span> <span class="n">exp</span><span class="p">)</span>
<a name="line-597"></a>       <span class="n">thisProxy</span><span class="p">[</span> <span class="n">targetnode</span> <span class="p">].</span><span class="n">addMesh</span><span class="p">(</span> <span class="n">CkMyNode</span><span class="p">(),</span> <span class="n">chunk</span> <span class="p">);</span>
<a name="line-598"></a>  <span class="p">}</span>
<a name="line-599"></a><span class="p">}</span>
<a name="line-600"></a>
<a name="line-601"></a><span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="o">&lt;</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">2</span> <span class="o">&gt;</span>
<a name="line-602"></a><span class="n">Partitioner</span><span class="o">::</span><span class="n">distribution</span><span class="p">(</span> <span class="kt">int</span> <span class="n">npart</span> <span class="p">)</span> <span class="k">const</span>
<a name="line-603"></a><span class="c1">// *****************************************************************************</span>
<a name="line-604"></a><span class="c1">//  Compute chare (partition) distribution</span>
<a name="line-605"></a><span class="c1">//! \param[in] npart Total number of chares (partitions) to distribute</span>
<a name="line-606"></a><span class="c1">//! \return Chunksize, i.e., number of chares per all compute nodes except the</span>
<a name="line-607"></a><span class="c1">//!   last one, and the number of chares for this compute node.</span>
<a name="line-608"></a><span class="c1">//! \details Chare ids are distributed to compute nodes in a linear continguous</span>
<a name="line-609"></a><span class="c1">//!   order with the last compute node taking the remainder if the number of</span>
<a name="line-610"></a><span class="c1">//!   compute nodes is not divisible by the number chares. For example, if</span>
<a name="line-611"></a><span class="c1">//!   nchare=7 and nnode=3, the chare distribution is node0: 0 1, node1: 2 3,</span>
<a name="line-612"></a><span class="c1">//!   and node2: 4 5 6. As a result of this distribution, all compute nodes will</span>
<a name="line-613"></a><span class="c1">//!   have their chare-categorized element connectivity filled with the global</span>
<a name="line-614"></a><span class="c1">//!   mesh node IDs associated to the Charm++ chare IDs each compute node owns.</span>
<a name="line-615"></a><span class="c1">// *****************************************************************************</span>
<a name="line-616"></a><span class="p">{</span>
<a name="line-617"></a>  <span class="k">auto</span> <span class="n">chunksize</span> <span class="o">=</span> <span class="n">npart</span> <span class="o">/</span> <span class="n">CkNumNodes</span><span class="p">();</span>
<a name="line-618"></a>  <span class="k">auto</span> <span class="n">mynchare</span> <span class="o">=</span> <span class="n">chunksize</span><span class="p">;</span>
<a name="line-619"></a>  <span class="k">if</span> <span class="p">(</span><span class="n">CkMyNode</span><span class="p">()</span> <span class="o">==</span> <span class="n">CkNumNodes</span><span class="p">()</span><span class="mi">-1</span><span class="p">)</span> <span class="n">mynchare</span> <span class="o">+=</span> <span class="n">npart</span> <span class="o">%</span> <span class="n">CkNumNodes</span><span class="p">();</span>
<a name="line-620"></a>  <span class="k">return</span> <span class="p">{{</span> <span class="n">chunksize</span><span class="p">,</span> <span class="n">mynchare</span> <span class="p">}};</span>
<a name="line-621"></a><span class="p">}</span>
<a name="line-622"></a>
<a name="line-623"></a><span class="n">Partitioner</span><span class="o">::~</span><span class="n">Partitioner</span><span class="p">()</span>
<a name="line-624"></a><span class="c1">// *****************************************************************************</span>
<a name="line-625"></a><span class="c1">//  Destructor</span>
<a name="line-626"></a><span class="c1">// *****************************************************************************</span>
<a name="line-627"></a><span class="p">{</span>
<a name="line-628"></a>  <span class="c1">// The following call has to be made on all MPI ranks to free all resources.</span>
<a name="line-629"></a>  <span class="c1">// see https://github.com/trilinos/Trilinos/issues/11197#issuecomment-1301325163</span>
<a name="line-630"></a>  <span class="n">Kokkos</span><span class="o">::</span><span class="n">finalize</span><span class="p">();</span>
<a name="line-631"></a><span class="p">}</span>
<a name="line-632"></a>
<a name="line-633"></a><span class="cp">#include</span> <span class="cpf">&quot;NoWarning/partitioner.def.h&quot;</span><span class="cp"></span>
</pre></div>
</td></tr></table>
      </div> <!-- /.wrapper -->
    </div>
    <div id="footer" class="footer">
      <p>
        Cppcheck 2.3 - a tool for static C/C++ code analysis<br>
        <br>
        Internet: <a href="http://cppcheck.net">http://cppcheck.net</a><br>
        IRC: <a href="irc://irc.freenode.net/cppcheck">irc://irc.freenode.net/cppcheck</a><br>
      </p>
    </div>
  </body>
</html>
